
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mss_dataserver.event.detection &#8212; mss_dataserver 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/haiku_maar.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../index.html">
          <span>mss_dataserver 0.0.1 documentation</span></a></h1>
        <h2 class="heading"><span>mss_dataserver.event.detection</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">mss_dataserver 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../event.html" accesskey="U">mss_dataserver.event</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">mss_dataserver.event.detection</a></li> 
      </ul>
    </div>
      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for mss_dataserver.event.detection</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&#39;&#39;&#39; Managing detections.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">mss_dataserver.geometry.db_inventory</span> <span class="k">as</span> <span class="nn">db_inventory</span>
<span class="kn">import</span> <span class="nn">obspy.core.utcdatetime</span> <span class="k">as</span> <span class="nn">utcdatetime</span>

<div class="viewcode-block" id="Detection"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Detection.html#mss_dataserver.event.detection.Detection">[docs]</a><span class="k">class</span> <span class="nc">Detection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A MSS Delaunay detection.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start_time: :class:`obspy.UTCDateTime`</span>
<span class="sd">        The start time of the detection.</span>

<span class="sd">    end_time: :class:`obspy.UTCDateTime`</span>
<span class="sd">        The end time of the detection.</span>

<span class="sd">    stations: :obj:`list` of :class:`~mss_dataserver.geometry.inventory.Station`</span>
<span class="sd">        3 stations related to the detection. They are the corners of a detection</span>
<span class="sd">        triangle.</span>

<span class="sd">    max_pgv: dict</span>
<span class="sd">        The maximum PGV values of the detection timespan. A dictionary of {station.nsl_string: PGV values}.</span>

<span class="sd">    db_id: int</span>
<span class="sd">        The database id of the detection.</span>

<span class="sd">    catalog_id: int</span>
<span class="sd">        The database id of the detection catalog which contains the detection.</span>

<span class="sd">    agency_uri: str</span>
<span class="sd">        The uniform resource identifier of the author agency.</span>

<span class="sd">    author_uri: str</span>
<span class="sd">        The uniform resource identifier of the author.</span>

<span class="sd">    creation_time: :class:`obspy.UTCDateTime`</span>
<span class="sd">        The creation time of the detection.</span>

<span class="sd">    parent: :class:`Catalog`</span>
<span class="sd">        The detection catalog holding the detection.</span>

<span class="sd">    changed: bool</span>
<span class="sd">        Flag indicating a change of the detection.</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Detection.__init__"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Detection.__init__.html#mss_dataserver.event.detection.Detection.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">max_pgv</span><span class="p">,</span>
                 <span class="n">db_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">catalog_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">agency_uri</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">author_uri</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">creation_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Initialize the instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Check for correct input arguments.</span>
        <span class="c1"># Check for None values in the event limits.</span>
        <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;None values are not allowed for the event time limits.&quot;</span><span class="p">)</span>

        <span class="c1"># Check the event limits.</span>
        <span class="k">if</span> <span class="n">end_time</span> <span class="o">&lt;</span> <span class="n">start_time</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The end_time </span><span class="si">%s</span><span class="s2"> is smaller than the start_time </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">start_time</span><span class="p">)</span>

        <span class="c1"># The parent object holding this event. Most likely this is a detection</span>
        <span class="c1"># Catalog instance or an event instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c1"># The unique database id.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span> <span class="o">=</span> <span class="n">db_id</span>

        <span class="c1"># The channel matching the rec_stream_id. This is loaded only if a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># The catalog id to which the detection belongs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_id</span> <span class="o">=</span> <span class="n">catalog_id</span>

        <span class="c1"># The start time of the event.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>

        <span class="c1"># The end time of the event.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">end_time</span><span class="p">)</span>

        <span class="c1"># The stations of the Delaunay triangle.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span>

        <span class="c1"># The max. PGV values of the detection timespan.</span>
        <span class="c1"># A dictionary of {station.nsl_string: PGV values}.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pgv</span> <span class="o">=</span> <span class="n">max_pgv</span>

        <span class="c1"># The agency_uri of the creator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span> <span class="o">=</span> <span class="n">agency_uri</span>

        <span class="c1"># The author_uri of the creator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span> <span class="o">=</span> <span class="n">author_uri</span>

        <span class="c1"># The time of creation of this event.</span>
        <span class="k">if</span> <span class="n">creation_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">creation_time</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">creation_time</span><span class="p">)</span>

        <span class="c1"># Flag to indicate a change of the detection attributes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="n">changed</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; str: The resource ID of the detection.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;/event/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_id</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_time_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; str: The string representation of the start time.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end_time_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; str: The string representation of the end time.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; float: The length of the detection in seconds.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nslc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; tuple of str: The NSLC code of the related channel.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">nslc</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; tuple of str: The NSLC code of the related channel.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">nslc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">nslc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">nslc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">absolute_max_pgv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; float: The absolute maximum PGV value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_pgv</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>


<div class="viewcode-block" id="Detection.update"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Detection.update.html#mss_dataserver.event.detection.Detection.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">max_pgv</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Update the attributes of the detection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_time: :class:`obspy.UTCDateTime` of :obj:`str`</span>
<span class="sd">            The new start time of the detection.</span>

<span class="sd">        end_time: :class:`obspy.UTCDateTime` of :obj:`str`</span>
<span class="sd">            The new end time of the detection.</span>

<span class="sd">        max_pgv: dict</span>
<span class="sd">            The new maximum PGV data. A dictionary of {station.nsl_string: PGV values}.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">end_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_pgv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cur_key</span><span class="p">,</span> <span class="n">cur_value</span> <span class="ow">in</span> <span class="n">max_pgv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">cur_value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pgv</span><span class="p">[</span><span class="n">cur_key</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_pgv</span><span class="p">[</span><span class="n">cur_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_value</span></div>



<div class="viewcode-block" id="Detection.set_channel_from_inventory"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Detection.set_channel_from_inventory.html#mss_dataserver.event.detection.Detection.set_channel_from_inventory">[docs]</a>    <span class="k">def</span> <span class="nf">set_channel_from_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inventory</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Set the channel matching the recorder stream.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inventory: :class:`~mss_dataserver.geometry.inventory.Inventory`</span>
<span class="sd">            The inventory used to match the channels.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">get_channel_from_stream</span><span class="p">(</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
                                                         <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span></div>


<div class="viewcode-block" id="Detection.write_to_database"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Detection.write_to_database.html#mss_dataserver.event.detection.Detection.write_to_database">[docs]</a>    <span class="k">def</span> <span class="nf">write_to_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Write the detection to the pSysmon database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project: :class:`~mss_dataserver.core.project.Project`</span>
<span class="sd">            The project used to access the database.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If the db_id is None, insert a new event.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">creation_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">creation_time</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">catalog_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">db_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">catalog_id</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">db_session</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_db_session</span><span class="p">()</span>
            <span class="n">db_detection_orm</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">db_tables</span><span class="p">[</span><span class="s1">&#39;detection&#39;</span><span class="p">]</span>
            <span class="n">db_detection</span> <span class="o">=</span> <span class="n">db_detection_orm</span><span class="p">(</span><span class="n">catalog_id</span> <span class="o">=</span> <span class="n">catalog_id</span><span class="p">,</span>
                                            <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                                            <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                                            <span class="n">stat1_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                            <span class="n">stat2_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                            <span class="n">stat3_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                            <span class="n">max_pgv1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_pgv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nsl_string</span><span class="p">]),</span>
                                            <span class="n">max_pgv2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_pgv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nsl_string</span><span class="p">]),</span>
                                            <span class="n">max_pgv3</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_pgv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">nsl_string</span><span class="p">]),</span>
                                            <span class="n">agency_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span><span class="p">,</span>
                                            <span class="n">author_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span><span class="p">,</span>
                                            <span class="n">creation_time</span> <span class="o">=</span> <span class="n">creation_time</span><span class="p">)</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">db_detection</span><span class="p">)</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span> <span class="o">=</span> <span class="n">db_detection</span><span class="o">.</span><span class="n">id</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the db_id is not None, update the existing event.</span>
            <span class="n">db_session</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_db_session</span><span class="p">()</span>
            <span class="n">db_detection_orm</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">db_tables</span><span class="p">[</span><span class="s1">&#39;detection&#39;</span><span class="p">]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">db_detection_orm</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db_detection_orm</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
                <span class="n">db_detection</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">db_detection</span><span class="o">.</span><span class="n">catalog_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">db_id</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">db_detection</span><span class="o">.</span><span class="n">catalog_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">db_detection</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="n">db_detection</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="n">db_detection</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span>
                <span class="n">db_detection</span><span class="o">.</span><span class="n">agency_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span>
                <span class="n">db_detection</span><span class="o">.</span><span class="n">author_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">db_detection</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">db_detection</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">db_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The detection with ID=</span><span class="si">%d</span><span class="s2"> was not found in the database.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Detection.get_db_orm"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Detection.get_db_orm.html#mss_dataserver.event.detection.Detection.get_db_orm">[docs]</a>    <span class="k">def</span> <span class="nf">get_db_orm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get an orm representation to use it for bulk insertion into</span>
<span class="sd">        the database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project: :class:`~mss_dataserver.core.project.Project`</span>
<span class="sd">            The project used to access the database.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`mss_dataserver.event.databaseFactory.DetectionDb`</span>
<span class="sd">            The database mapper class instance of the detection.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">db_detection_orm</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">db_tables</span><span class="p">[</span><span class="s1">&#39;detection&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">creation_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">creation_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">catalog_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">db_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">catalog_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;catalog_id&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="s1">&#39;end_time&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;agency_uri&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;author_uri&#39;</span><span class="p">,</span> <span class="s1">&#39;creation_time&#39;</span><span class="p">]</span>
        <span class="n">db_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">catalog_id</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span><span class="p">,</span>
                            <span class="n">creation_time</span><span class="p">))))</span>
        <span class="n">db_detection</span> <span class="o">=</span> <span class="n">db_detection_orm</span><span class="p">(</span><span class="o">**</span><span class="n">db_dict</span><span class="p">)</span>
        <span class="n">db_detection</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span>
        <span class="k">return</span> <span class="n">db_detection</span></div>

<div class="viewcode-block" id="Detection.from_orm"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Detection.from_orm.html#mss_dataserver.event.detection.Detection.from_orm">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_orm</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">detection_orm</span><span class="p">,</span> <span class="n">inventory</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Convert a database orm mapper detection to a detection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        detection_orm : :class:`mss_dataserver.event.databaseFactory.DetectionDb`</span>
<span class="sd">            The ORM of the detection_orm database table.</span>

<span class="sd">        inventory: :class:`~mss_dataserver.geometry.db_inventory.Inventory`</span>
<span class="sd">            The geometry inventory used to retrieve the stations of the detection.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">stat1</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">get_station</span><span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">stat1_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stat2</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">get_station</span><span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">stat2_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stat3</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">get_station</span><span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">stat3_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">detection</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
                        <span class="n">end_time</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span>
                        <span class="n">db_id</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">catalog_id</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">catalog_id</span><span class="p">,</span>
                        <span class="n">stations</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat1</span><span class="p">,</span> <span class="n">stat2</span><span class="p">,</span> <span class="n">stat3</span><span class="p">],</span>
                        <span class="n">max_pgv</span> <span class="o">=</span> <span class="p">{</span><span class="n">stat1</span><span class="o">.</span><span class="n">nsl_string</span><span class="p">:</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">max_pgv1</span><span class="p">,</span>
                                   <span class="n">stat2</span><span class="o">.</span><span class="n">nsl_string</span><span class="p">:</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">max_pgv2</span><span class="p">,</span>
                                   <span class="n">stat3</span><span class="o">.</span><span class="n">nsl_string</span><span class="p">:</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">max_pgv3</span><span class="p">},</span>
                        <span class="n">agency_uri</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">agency_uri</span><span class="p">,</span>
                        <span class="n">author_uri</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">author_uri</span><span class="p">,</span>
                        <span class="n">creation_time</span> <span class="o">=</span> <span class="n">detection_orm</span><span class="o">.</span><span class="n">creation_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">detection</span></div></div>



<div class="viewcode-block" id="Catalog"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.html#mss_dataserver.event.detection.Catalog">[docs]</a><span class="k">class</span> <span class="nc">Catalog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A detection catalog.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: str </span>
<span class="sd">        The name of the catalog.</span>

<span class="sd">    db_id: int</span>
<span class="sd">        The database id of the catalog.</span>

<span class="sd">    description: str</span>
<span class="sd">        The description of the catalog.</span>

<span class="sd">    agency_uri: str</span>
<span class="sd">        The uniform resource identifier of the author agency.</span>

<span class="sd">    author_uri: str</span>
<span class="sd">        The uniform resource identifier of the author.</span>

<span class="sd">    creation_time: :class:`obspy.UTCDateTime`</span>
<span class="sd">        The creation time of the detection.</span>

<span class="sd">    detections: :obj:`list` of :class:`Detection`</span>
<span class="sd">        The detections of the catalog.</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Catalog.__init__"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.__init__.html#mss_dataserver.event.detection.Catalog.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">db_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">agency_uri</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">author_uri</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">creation_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">detections</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Instance initialization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># The logging logger instance.</span>
        <span class="n">logger_name</span> <span class="o">=</span> <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>

        <span class="c1"># The unique database ID.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span> <span class="o">=</span> <span class="n">db_id</span>

        <span class="c1"># The name of the catalog.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># The description of the catalog.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>

        <span class="c1"># The agency_uri of the creator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span> <span class="o">=</span> <span class="n">agency_uri</span>

        <span class="c1"># The author_uri of the creator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span> <span class="o">=</span> <span class="n">author_uri</span>

        <span class="c1"># The time of creation of this event.</span>
        <span class="k">if</span> <span class="n">creation_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">();</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">creation_time</span><span class="p">);</span>

        <span class="c1"># The detections of the catalog.</span>
        <span class="k">if</span> <span class="n">detections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detections</span> <span class="o">=</span> <span class="n">detections</span></div>


<div class="viewcode-block" id="Catalog.add_detections"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.add_detections.html#mss_dataserver.event.detection.Catalog.add_detections">[docs]</a>    <span class="k">def</span> <span class="nf">add_detections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detections</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add one or more detections to the catalog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        detections : list of :class:`Detection`</span>
<span class="sd">            The detections to add to the catalog.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Check for potential duplicates.</span>
        <span class="c1"># TODO: add a compare method for the detection class.</span>
        <span class="n">db_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">db_id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">detections</span><span class="p">]</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">detections</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">db_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">db_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db_ids</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">cur_detection</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
            <span class="n">cur_detection</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detections</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span></div>


<div class="viewcode-block" id="Catalog.remove_detections"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.remove_detections.html#mss_dataserver.event.detection.Catalog.remove_detections">[docs]</a>    <span class="k">def</span> <span class="nf">remove_detections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detections</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Remove the detections from the catalog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        detections : list of :class:`Detection`</span>
<span class="sd">            The detections to add to the catalog.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">cur_detection</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur_detection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">detections</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">detections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cur_detection</span><span class="p">)</span></div>


<div class="viewcode-block" id="Catalog.get_detections"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.get_detections.html#mss_dataserver.event.detection.Catalog.get_detections">[docs]</a>    <span class="k">def</span> <span class="nf">get_detections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">start_inside</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">end_inside</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get detections using search criteria passed as keywords.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_time : class:`obspy.UTCDateTime`</span>
<span class="sd">            The minimum starttime of the detections.</span>

<span class="sd">        end_time : class:`obspy.UTCDateTime`</span>
<span class="sd">            The maximum end_time of the detections.</span>

<span class="sd">        start_inside : bool</span>
<span class="sd">            If True, select only those detection with a start time</span>
<span class="sd">            inside the search window.</span>

<span class="sd">        end_inside : bool</span>
<span class="sd">            If True, select only those detection with an end time</span>
<span class="sd">            inside the search window.</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        nslc: :obj:`tuple` of :obj:`str`</span>
<span class="sd">            The network-station-location-channel code (e.g (&#39;XX&#39;, &#39;DUBA&#39;, &#39;00&#39;, &#39;HNormal&#39;)).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`Detection`</span>
<span class="sd">            The detection matching the search criteria.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ret_detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detections</span>

        <span class="n">valid_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nslc&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">cur_key</span><span class="p">,</span> <span class="n">cur_value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cur_key</span> <span class="ow">in</span> <span class="n">valid_keys</span><span class="p">:</span>
                <span class="n">ret_detections</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret_detections</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cur_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">cur_value</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Search attribute </span><span class="si">%s</span><span class="s1"> is not existing.&#39;</span> <span class="o">%</span> <span class="n">cur_key</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start_inside</span><span class="p">:</span>
                <span class="n">ret_detections</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret_detections</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret_detections</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret_detections</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="n">start_time</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">end_inside</span><span class="p">:</span>
                <span class="n">ret_detections</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret_detections</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret_detections</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret_detections</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ret_detections</span></div>


<div class="viewcode-block" id="Catalog.assign_channel"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.assign_channel.html#mss_dataserver.event.detection.Catalog.assign_channel">[docs]</a>    <span class="k">def</span> <span class="nf">assign_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inventory</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Set the channels according to the rec_stream_ids.</span>

<span class="sd">        Parameters.</span>
<span class="sd">        -----------</span>
<span class="sd">        inventory: :class:`~mss_dataserver.geometry.inventory.Inventory`</span>
<span class="sd">            The inventory used to get the matching channels.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Get the unique stream ids.</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">rec_stream_id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">detections</span><span class="p">]</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">id_list</span><span class="p">))</span>
        <span class="c1"># Get the channels for the ids.</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">inventory</span><span class="o">.</span><span class="n">get_channel_from_stream</span><span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">]</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">]</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="n">channels</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">cur_detection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">detections</span><span class="p">:</span>
            <span class="n">cur_detection</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">cur_detection</span><span class="o">.</span><span class="n">rec_stream_id</span><span class="p">]</span></div>


    <span class="c1">#@profile(immediate=True)</span>
<div class="viewcode-block" id="Catalog.load_detections"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.load_detections.html#mss_dataserver.event.detection.Catalog.load_detections">[docs]</a>    <span class="k">def</span> <span class="nf">load_detections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">min_detection_length</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Load detections from the database.</span>

<span class="sd">        The query can be limited using the allowed keyword arguments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_time : :class:`obspy.UTCDateTime`</span>
<span class="sd">            The begin of the time-span to load.</span>

<span class="sd">        end_time : :class:`obspy.UTCDateTime`</span>
<span class="sd">            The end of the time-span to load.</span>

<span class="sd">        min_detection_length: float</span>
<span class="sd">            The minimum length of the detection.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The project is None. Can&#39;t query the database without a project.&quot;</span><span class="p">)</span>

        <span class="n">db_session</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_db_session</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">detection_table</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">db_tables</span><span class="p">[</span><span class="s1">&#39;detection&#39;</span><span class="p">]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">detection_table</span><span class="p">)</span><span class="o">.</span>\
                    <span class="nb">filter</span><span class="p">(</span><span class="n">detection_table</span><span class="o">.</span><span class="n">catalog_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span><span class="p">)</span><span class="o">.</span>\
                    <span class="nb">filter</span><span class="p">(</span><span class="n">detection_table</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="n">detection_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start_time</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">detection_table</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">end_time</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">detection_table</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">min_detection_length</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">detection_table</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">detection_table</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&gt;=</span> <span class="n">min_detection_length</span><span class="p">)</span>

            <span class="n">detections_to_add</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cur_orm</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cur_detection</span> <span class="o">=</span> <span class="n">Detection</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">cur_orm</span><span class="p">)</span>
                    <span class="n">detections_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_detection</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error when creating a detection object from database values for detection id </span><span class="si">%d</span><span class="s2">. Skipping this detection.&quot;</span><span class="p">,</span> <span class="n">cur_orm</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_detections</span><span class="p">(</span><span class="n">detections_to_add</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Catalog.clear_detections"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.clear_detections.html#mss_dataserver.event.detection.Catalog.clear_detections">[docs]</a>    <span class="k">def</span> <span class="nf">clear_detections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Clear the detections list.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detections</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Catalog.write_to_database"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.write_to_database.html#mss_dataserver.event.detection.Catalog.write_to_database">[docs]</a>    <span class="k">def</span> <span class="nf">write_to_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Write the catalog to the database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project: :class:`~mss_dataserver.core.project.Project`</span>
<span class="sd">            The project used to access the database.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If the db_id is None, insert a new catalog.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">creation_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">creation_time</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">db_session</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_db_session</span><span class="p">()</span>
            <span class="n">db_catalog_orm</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">db_tables</span><span class="p">[</span><span class="s1">&#39;detection_catalog&#39;</span><span class="p">]</span>
            <span class="n">db_catalog</span> <span class="o">=</span> <span class="n">db_catalog_orm</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                                    <span class="n">agency_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span><span class="p">,</span>
                                    <span class="n">author_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span><span class="p">,</span>
                                    <span class="n">creation_time</span> <span class="o">=</span> <span class="n">creation_time</span>
                                   <span class="p">)</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">db_catalog</span><span class="p">)</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span> <span class="o">=</span> <span class="n">db_catalog</span><span class="o">.</span><span class="n">id</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the db_id is not None, update the existing catalog.</span>
            <span class="n">db_session</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_db_session</span><span class="p">()</span>
            <span class="n">db_catalog_orm</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">db_tables</span><span class="p">[</span><span class="s1">&#39;detection_catalog&#39;</span><span class="p">]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">db_catalog_orm</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db_catalog_orm</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
                <span class="n">db_catalog</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

                <span class="n">db_catalog</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="n">db_catalog</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
                <span class="n">db_catalog</span><span class="o">.</span><span class="n">agency_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span>
                <span class="n">db_catalog</span><span class="o">.</span><span class="n">author_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">db_catalog</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">db_catalog</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">db_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The detection catalog with ID=</span><span class="si">%d</span><span class="s2"> was not found in the database.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_id</span><span class="p">)</span>


        <span class="c1"># Write or update all detections of the catalog to the database.</span>
        <span class="k">for</span> <span class="n">cur_detection</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">detections</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">changed</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">]:</span>
            <span class="n">cur_detection</span><span class="o">.</span><span class="n">write_to_database</span><span class="p">(</span><span class="n">project</span><span class="p">)</span></div>



<div class="viewcode-block" id="Catalog.from_orm"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Catalog.from_orm.html#mss_dataserver.event.detection.Catalog.from_orm">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_orm</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db_catalog</span><span class="p">,</span> <span class="n">load_detections</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Convert a database orm mapper catalog to a catalog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_catalog: :class:`mss_dataserver.event.databaseFactory.DetectionCatalogDb`</span>
<span class="sd">            The table mapperclass of the detection catalog database table.</span>

<span class="sd">        load_detections: bool</span>
<span class="sd">            If true all detections contained in the catalog are loaded</span>
<span class="sd">            from the database.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`Detection`</span>
<span class="sd">            The detection class created using the database ORM instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">db_catalog</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                      <span class="n">db_id</span> <span class="o">=</span> <span class="n">db_catalog</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                      <span class="n">description</span> <span class="o">=</span> <span class="n">db_catalog</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                      <span class="n">agency_uri</span> <span class="o">=</span> <span class="n">db_catalog</span><span class="o">.</span><span class="n">agency_uri</span><span class="p">,</span>
                      <span class="n">author_uri</span> <span class="o">=</span> <span class="n">db_catalog</span><span class="o">.</span><span class="n">author_uri</span><span class="p">,</span>
                      <span class="n">creation_time</span> <span class="o">=</span> <span class="n">db_catalog</span><span class="o">.</span><span class="n">creation_time</span>
                      <span class="p">)</span>

        <span class="c1"># Add the detections to the catalog.</span>
        <span class="k">if</span> <span class="n">load_detections</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cur_detection_orm</span> <span class="ow">in</span> <span class="n">db_catalog</span><span class="o">.</span><span class="n">detections</span><span class="p">:</span>
                <span class="n">cur_detection</span> <span class="o">=</span> <span class="n">Detection</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">cur_detection_orm</span><span class="p">)</span>
                <span class="n">catalog</span><span class="o">.</span><span class="n">add_detections</span><span class="p">([</span><span class="n">cur_detection</span><span class="p">,])</span>
        <span class="k">return</span> <span class="n">catalog</span></div></div>



<div class="viewcode-block" id="Library"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Library.html#mss_dataserver.event.detection.Library">[docs]</a><span class="k">class</span> <span class="nc">Library</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Manage detection catalogs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: str</span>
<span class="sd">        The name of the library.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    catalogs: dict</span>
<span class="sd">        The catalogs managed by the library. The key is the name of the catalog. </span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Library.__init__"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Library.__init__.html#mss_dataserver.event.detection.Library.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Initialize the instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># The name of the library.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># The catalogs of the library.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalogs</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="Library.add_catalog"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Library.add_catalog.html#mss_dataserver.event.detection.Library.add_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">add_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catalog</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add one or more catalogs to the library.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        catalog : :class:`Catalog` or :obj:`list` of :class:`Catalog`</span>
<span class="sd">            The catalog(s) to add to the library.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cur_catalog</span> <span class="ow">in</span> <span class="n">catalog</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_catalog</span><span class="p">(</span><span class="n">cur_catalog</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalogs</span><span class="p">[</span><span class="n">catalog</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog</span></div>


<div class="viewcode-block" id="Library.remove_catalog"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Library.remove_catalog.html#mss_dataserver.event.detection.Library.remove_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">remove_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Remove a catalog from the library.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : String</span>
<span class="sd">            The name of the catalog to remove.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        removed_catalog : :class:`Catalog`</span>
<span class="sd">            The removed catalog. None if no catalog was removed.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalogs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalogs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Library.clear"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Library.clear.html#mss_dataserver.event.detection.Library.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Remove all catalogs.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalogs</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="Library.get_catalogs_in_db"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Library.get_catalogs_in_db.html#mss_dataserver.event.detection.Library.get_catalogs_in_db">[docs]</a>    <span class="k">def</span> <span class="nf">get_catalogs_in_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Query the available catalogs in the database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project : :class:`psysmon.core.project.Project`</span>
<span class="sd">            The project managing the database.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        catalog_names : List of Strings</span>
<span class="sd">            The available catalog names in the database.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">catalog_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">db_session</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_db_session</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_catalog_orm</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">db_tables</span><span class="p">[</span><span class="s1">&#39;detection_catalog&#39;</span><span class="p">]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">db_catalog_orm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
                <span class="n">catalog_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">db_catalog_orm</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">catalog_names</span></div>


<div class="viewcode-block" id="Library.load_catalog_from_db"><a class="viewcode-back" href="../../../autogen/mss_dataserver.event.detection.Library.load_catalog_from_db.html#mss_dataserver.event.detection.Library.load_catalog_from_db">[docs]</a>    <span class="k">def</span> <span class="nf">load_catalog_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">load_detections</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Load catalogs from the database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project : :class:`psysmon.core.project.Project`</span>
<span class="sd">            The project managing the database.</span>

<span class="sd">        name : String or list of Strings</span>
<span class="sd">            The name of the catalog to load from the database.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">db_session</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_db_session</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_catalog_orm</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">db_tables</span><span class="p">[</span><span class="s1">&#39;detection_catalog&#39;</span><span class="p">]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">db_catalog_orm</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db_catalog_orm</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">cur_db_catalog</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
                    <span class="n">cur_catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">cur_db_catalog</span><span class="p">,</span> <span class="n">load_detections</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_catalog</span><span class="p">(</span><span class="n">cur_catalog</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">mss_dataserver 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../event.html" >mss_dataserver.event</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">mss_dataserver.event.detection</a></li> 
      </ul>
    </div>
      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Stefan Mertl.
      Last updated on 2021-04-22 20:20.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.4.
    </div>
  </body>
</html>