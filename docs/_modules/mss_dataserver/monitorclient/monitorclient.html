

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>mss_dataserver.monitorclient.monitorclient &mdash; mss_dataserver 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> mss_dataserver
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userdoc/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userdoc/usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userdoc/database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sourcedoc/index.html">Modules</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mss_dataserver</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mss_dataserver.monitorclient.monitorclient</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mss_dataserver.monitorclient.monitorclient</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">##############################################################################</span>
 <span class="c1"># LICENSE</span>
 <span class="c1">#</span>
 <span class="c1"># This file is part of mss_dataserver.</span>
 <span class="c1"># </span>
 <span class="c1"># If you use mss_dataserver in any program or publication, please inform and</span>
 <span class="c1"># acknowledge its authors.</span>
 <span class="c1"># </span>
 <span class="c1"># mss_dataserver is free software: you can redistribute it and/or modify</span>
 <span class="c1"># it under the terms of the GNU General Public License as published by</span>
 <span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
 <span class="c1"># (at your option) any later version.</span>
 <span class="c1"># </span>
 <span class="c1"># mss_dataserver is distributed in the hope that it will be useful,</span>
 <span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
 <span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
 <span class="c1"># GNU General Public License for more details.</span>
 <span class="c1"># </span>
 <span class="c1"># You should have received a copy of the GNU General Public License</span>
 <span class="c1"># along with mss_dataserver. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
 <span class="c1">#</span>
 <span class="c1"># Copyright 2019 Stefan Mertl</span>
<span class="c1">##############################################################################</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">obspy</span>
<span class="kn">import</span> <span class="nn">obspy.core.utcdatetime</span> <span class="k">as</span> <span class="nn">utcdatetime</span>
<span class="kn">import</span> <span class="nn">obspy.clients.seedlink.easyseedlink</span> <span class="k">as</span> <span class="nn">easyseedlink</span>
<span class="kn">from</span> <span class="nn">obspy.clients.seedlink.slpacket</span> <span class="kn">import</span> <span class="n">SLPacket</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span>

<span class="kn">import</span> <span class="nn">mss_dataserver.core.json_util</span> <span class="k">as</span> <span class="nn">json_util</span>
<span class="kn">import</span> <span class="nn">mss_dataserver.core.validation</span> <span class="k">as</span> <span class="nn">validation</span>
<span class="kn">import</span> <span class="nn">mss_dataserver.event.core</span> <span class="k">as</span> <span class="nn">event_core</span>
<span class="kn">import</span> <span class="nn">mss_dataserver.event.detection</span> <span class="k">as</span> <span class="nn">event_detection</span>
<span class="kn">import</span> <span class="nn">mss_dataserver.event.delaunay_detection</span> <span class="k">as</span> <span class="nn">event_ddet</span>
<span class="kn">import</span> <span class="nn">mss_dataserver.postprocess.util</span> <span class="k">as</span> <span class="nn">pp_util</span>


<div class="viewcode-block" id="EasySeedLinkClientException"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.EasySeedLinkClientException.html#mss_dataserver.monitorclient.monitorclient.EasySeedLinkClientException">[docs]</a><span class="k">class</span> <span class="nc">EasySeedLinkClientException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base exception for all errors triggered explicitly by EasySeedLinkClient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># XXX Base on SeedLinkException?</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="MonitorClient"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.html#mss_dataserver.monitorclient.monitorclient.MonitorClient">[docs]</a><span class="k">class</span> <span class="nc">MonitorClient</span><span class="p">(</span><span class="n">easyseedlink</span><span class="o">.</span><span class="n">EasySeedLinkClient</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A custom SeedLink client</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    project: :class:`mss_dataserver.core.project.Project`</span>
<span class="sd">        The mss_dataserver project.</span>

<span class="sd">    server_url: str </span>
<span class="sd">        The URL of the server.</span>

<span class="sd">    stations: :obj:`list` of :obj:`str`</span>
<span class="sd">        The stations to request from the seedlink server.</span>

<span class="sd">    monitor_stream: :class:`obspy.Stream`</span>
<span class="sd">        The stream instance used to save the incoming data.</span>

<span class="sd">    stream_lock: :class:`threading.Lock`</span>
<span class="sd">        The lock object used to for thread-save access of the stream data.</span>

<span class="sd">    data_dir: str </span>
<span class="sd">        The data directory.</span>

<span class="sd">    event_dir: str </span>
<span class="sd">        The event directory.</span>

<span class="sd">    process_interval: float </span>
<span class="sd">        The time interval [s] used to process the received data.</span>

<span class="sd">    stop_event: :class:`threading.Event`</span>
<span class="sd">        The event used to signal the stopping of the program execution.</span>

<span class="sd">    asyncio_loop: :class:`asyncio.EventLoop`</span>
<span class="sd">        The asyncio event loop. Used to stop the loop if an error occurs.</span>

<span class="sd">    pgv_sps: float </span>
<span class="sd">        The samples per second of the PGV data stream.</span>

<span class="sd">    autoconnect: boolean</span>
<span class="sd">        The :class:`obspy.easyseedlink.EasySeedLinkClient` autoconnect parameter.</span>

<span class="sd">    pgv_archive_time: float</span>
<span class="sd">        The length of the archive stream to keep [s].</span>

<span class="sd">    trigger_thr: float </span>
<span class="sd">        The event trigger threshold [m/s].</span>

<span class="sd">    warn_thr: float </span>
<span class="sd">        The event warning threshold [m/s].</span>

<span class="sd">    valid_event_thr: float</span>
<span class="sd">        The threshold to declare an event as a valid event [m/s].</span>
<span class="sd">    </span>
<span class="sd">    felt_thr: float </span>
<span class="sd">        The threshold above which an event is considered as a felt event [m/s].</span>

<span class="sd">    event_archive_timespan: float </span>
<span class="sd">        The timespan used to load archived events [h].</span>

<span class="sd">    min_event_length: float </span>
<span class="sd">        The minimum length of an event [s]. Events smaller than this value are </span>
<span class="sd">        ignored.</span>

<span class="sd">    min_event_detections: int </span>
<span class="sd">        The minimum number of detections for an event to be saved in the archive.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="MonitorClient.__init__"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.__init__.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">server_url</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span>
                 <span class="n">monitor_stream</span><span class="p">,</span> <span class="n">stream_lock</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">event_dir</span><span class="p">,</span>
                 <span class="n">process_interval</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">,</span> <span class="n">asyncio_loop</span><span class="p">,</span>
                 <span class="n">pgv_sps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">autoconnect</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pgv_archive_time</span> <span class="o">=</span> <span class="mi">1800</span><span class="p">,</span>
                 <span class="n">trigger_thr</span> <span class="o">=</span> <span class="mf">0.01e-3</span><span class="p">,</span> <span class="n">warn_thr</span> <span class="o">=</span> <span class="mf">0.01e-3</span><span class="p">,</span>
                 <span class="n">valid_event_thr</span> <span class="o">=</span> <span class="mf">0.1e-3</span><span class="p">,</span> <span class="n">felt_thr</span> <span class="o">=</span> <span class="mf">0.1e-3</span><span class="p">,</span>
                 <span class="n">event_archive_timespan</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span> <span class="n">min_event_length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="n">min_event_detections</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Initialize the instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">easyseedlink</span><span class="o">.</span><span class="n">EasySeedLinkClient</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                 <span class="n">server_url</span> <span class="o">=</span> <span class="n">server_url</span><span class="p">,</span>
                                                 <span class="n">autoconnect</span> <span class="o">=</span> <span class="n">autoconnect</span><span class="p">)</span>
        <span class="n">logger_name</span> <span class="o">=</span> <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>

        <span class="c1"># Set the logging level of obspy module.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;obspy.clients.seedlink&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

        <span class="c1"># The project instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

        <span class="c1"># The URI of the agency.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">agency_uri</span>

        <span class="c1"># The URI of the author.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">author_uri</span>

        <span class="c1"># The asyncio event loop. Used to stop the loop if an error occures.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asyncio_loop</span> <span class="o">=</span> <span class="n">asyncio_loop</span>

        <span class="c1"># The stations to stream from the seedlink server.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span>

        <span class="c1"># The recent, not yet processed data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span> <span class="o">=</span> <span class="n">monitor_stream</span>

        <span class="c1"># The stream used for processing.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>

        <span class="c1"># The pgv stream holding the most recent data which has not been sent</span>
        <span class="c1"># over the websocket.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>

        <span class="c1"># The pgv archive stream holding the PGV data of the specified archive</span>
        <span class="c1"># time.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>

        <span class="c1"># The velocity waveform data archive stream with the same length as the</span>
        <span class="c1"># PGV archive stream.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_stream</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>

        <span class="c1"># The length of the archive stream to keep [s].</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_time</span> <span class="o">=</span> <span class="n">pgv_archive_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_time</span> <span class="o">=</span> <span class="n">pgv_archive_time</span>

        <span class="c1"># The no-data value.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodata_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999999</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span> <span class="o">=</span> <span class="n">stream_lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="c1"># The common data output directory.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>

        <span class="c1"># The event data output directory.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supplement_dir</span> <span class="o">=</span> <span class="n">event_dir</span>

        <span class="c1"># The time interval [s] used to process the received data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_interval</span> <span class="o">=</span> <span class="n">process_interval</span>

        <span class="c1"># The samples per second of the PGV data stream.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgv_sps</span> <span class="o">=</span> <span class="n">pgv_sps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span> <span class="o">=</span> <span class="n">stop_event</span>

        <span class="c1"># The trigger parameters.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_thr</span> <span class="o">=</span> <span class="n">trigger_thr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warn_thr</span> <span class="o">=</span> <span class="n">warn_thr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_event_thr</span> <span class="o">=</span> <span class="n">valid_event_thr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">felt_thr</span> <span class="o">=</span> <span class="n">felt_thr</span>

        <span class="c1"># The most recent detected event.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_triggered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># The last detected events.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_archive</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># The event warning.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># The latest event detection result.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_detection_result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># The PGV data state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgv_data_available</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># The event detection result state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_detection_result_available</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># The event warning state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_warning_available</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># The event trigger state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event_available</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># The event archive state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_archive_changed</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># The keydata event.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_keydata_available</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># The psysmon geometry inventory.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">inventory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">compute_utm_coordinates</span><span class="p">()</span>

        <span class="c1"># The delaunay detector instance.</span>
        <span class="n">all_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">get_station</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">event_ddet</span><span class="o">.</span><span class="n">DelaunayDetector</span><span class="p">(</span><span class="n">network_stations</span> <span class="o">=</span> <span class="n">all_stations</span><span class="p">,</span>
                                                    <span class="n">trigger_thr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_thr</span><span class="p">,</span>
                                                    <span class="n">window_length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                                    <span class="n">safety_time</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                                    <span class="n">p_vel</span> <span class="o">=</span> <span class="mi">3500</span><span class="p">,</span>
                                                    <span class="n">min_trigger_window</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                    <span class="n">max_edge_length</span> <span class="o">=</span> <span class="mi">40000</span><span class="p">,</span>
                                                    <span class="n">author_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span><span class="p">,</span>
                                                    <span class="n">agency_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">recorder_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recorder_mappings</span><span class="p">(</span><span class="n">station_nsl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c1"># The required limits of an event to be saved in the archive.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_event_length</span> <span class="o">=</span> <span class="n">min_event_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_event_detections</span> <span class="o">=</span> <span class="n">min_event_detections</span>

        <span class="c1"># Load the archived data.</span>
        <span class="c1"># The timespan to load in hours.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_archive_timespan</span> <span class="o">=</span> <span class="n">event_archive_timespan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_archive_catalogs</span><span class="p">(</span><span class="n">hours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_archive_timespan</span><span class="p">)</span></div>

<div class="viewcode-block" id="MonitorClient.reset"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.reset.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Reset the monitorclient to an initial state.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_stream</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_triggered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">event_library</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_archive_catalogs</span><span class="p">(</span><span class="n">hours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_archive_timespan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>


<div class="viewcode-block" id="MonitorClient.seedlink_connect"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.seedlink_connect.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.seedlink_connect">[docs]</a>    <span class="k">def</span> <span class="nf">seedlink_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Connect to the seedlink server.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cur_mss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorder_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_stream</span><span class="p">(</span><span class="n">cur_mss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">cur_mss</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">cur_mss</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">cur_mss</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span></div>


<div class="viewcode-block" id="MonitorClient.load_archive_catalogs"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.load_archive_catalogs.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.load_archive_catalogs">[docs]</a>    <span class="k">def</span> <span class="nf">load_archive_catalogs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span> <span class="o">=</span> <span class="mi">48</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Load the event catalogs of the specified last days.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hours: float </span>
<span class="sd">            The timespan before now to load [h].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading archive catalogs for the last </span><span class="si">%d</span><span class="s2"> hours.&quot;</span><span class="p">,</span> <span class="n">hours</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">3600</span>
        <span class="n">start_day</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">year</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                            <span class="n">julday</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">julday</span><span class="p">)</span>
        <span class="n">n_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_day</span><span class="p">)</span> <span class="o">/</span> <span class="mi">86400</span><span class="p">)</span>
        <span class="n">n_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_days</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_days</span><span class="p">):</span>
            <span class="n">cur_cat_date</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">86400</span>
            <span class="n">cur_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:04d}</span><span class="s2">-</span><span class="si">{1:02d}</span><span class="s2">-</span><span class="si">{2:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur_cat_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                                        <span class="n">cur_cat_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                        <span class="n">cur_cat_date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Requesting catalog </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lock</span><span class="p">:</span>
                <span class="n">cur_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">load_event_catalog</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">cur_name</span><span class="p">,</span>
                                                          <span class="n">load_events</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cur_cat</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;events in catalog: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur_cat</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Catalog keys: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">event_library</span><span class="o">.</span><span class="n">catalogs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="MonitorClient.trim_archive_catalogs"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.trim_archive_catalogs.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.trim_archive_catalogs">[docs]</a>    <span class="k">def</span> <span class="nf">trim_archive_catalogs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span> <span class="o">=</span> <span class="mi">48</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Trim the catalogs in the library to the given timespan.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hours: float </span>
<span class="sd">            The timespan before now used to trim the catalogs [h].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Trimming the event catalogs to </span><span class="si">%d</span><span class="s1"> hours from now.&#39;</span><span class="p">,</span>
                         <span class="n">hours</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Catalog keys before trim: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">event_library</span><span class="o">.</span><span class="n">catalogs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">3600</span>
        <span class="n">start_day</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">year</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                            <span class="n">julday</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">julday</span><span class="p">)</span>
        <span class="n">n_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_day</span><span class="p">)</span> <span class="o">/</span> <span class="mi">86400</span><span class="p">)</span>
        <span class="n">n_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_days</span><span class="p">)</span>
        <span class="n">catalogs_to_keep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_days</span><span class="p">):</span>
            <span class="n">cur_cat_date</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">86400</span>
            <span class="n">cur_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:04d}</span><span class="s2">-</span><span class="si">{1:02d}</span><span class="s2">-</span><span class="si">{2:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur_cat_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                                        <span class="n">cur_cat_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                        <span class="n">cur_cat_date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="n">catalogs_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_name</span><span class="p">)</span>

        <span class="n">available_catalogs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">event_library</span><span class="o">.</span><span class="n">catalogs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">catalogs_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">available_catalogs</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">catalogs_to_keep</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Catalog to remove </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">catalogs_to_remove</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cur_name</span> <span class="ow">in</span> <span class="n">catalogs_to_remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">event_library</span><span class="o">.</span><span class="n">remove_catalog</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">cur_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Catalog keys after trim: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">event_library</span><span class="o">.</span><span class="n">catalogs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="MonitorClient.load_archive_file"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.load_archive_file.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.load_archive_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_archive_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Load data from the JSON archive file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">archive_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
                                        <span class="s1">&#39;mss_dataserver_archive.json&#39;</span><span class="p">)</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">archive_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                    <span class="n">archive</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loaded the archive from file </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                                     <span class="n">archive_filename</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t load the archive file </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                                      <span class="n">archive_filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">archive</span></div>

<div class="viewcode-block" id="MonitorClient.load_from_archive"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.load_from_archive.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.load_from_archive">[docs]</a>    <span class="k">def</span> <span class="nf">load_from_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Load data from a saved archive.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_archive_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">archive</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;current_event&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="n">archive</span><span class="p">[</span><span class="s1">&#39;current_event&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">])</span>
                <span class="c1"># TODO: Handle the loading of the pgv data stream.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="p">[</span><span class="s1">&#39;pgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;event_archive&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_archive</span> <span class="o">=</span> <span class="n">archive</span><span class="p">[</span><span class="s1">&#39;event_archive&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">cur_event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_archive</span><span class="p">:</span>
                    <span class="n">cur_event</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">cur_event</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span>
                    <span class="n">cur_event</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">cur_event</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="MonitorClient.save_to_archive"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.save_to_archive.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.save_to_archive">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save data to the JSON archive.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key: str </span>
<span class="sd">            The data key (&#39;current_event&#39;, &#39;event_archive&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">archive_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
                                        <span class="s1">&#39;mss_dataserver_archive.json&#39;</span><span class="p">)</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_archive_file</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;current_event&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_event</span><span class="p">()</span>
            <span class="c1"># TODO: Handle the saving of the event PGV data.</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;event_archive&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_archive</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">archive</span><span class="p">[</span><span class="s1">&#39;last_write&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">archive</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">archive_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">pref</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saved the archive to file </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                                 <span class="n">archive_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error saving the data to the archive. data: </span><span class="si">%s</span><span class="s2">, archive: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="n">data</span><span class="p">,</span> <span class="n">archive</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorClient.get_recorder_mappings"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_recorder_mappings.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_recorder_mappings">[docs]</a>    <span class="k">def</span> <span class="nf">get_recorder_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station_nsl</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get the mappings of the requested NSLC.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        station_nsl: :obj:`list` of :obj:`str`</span>
<span class="sd">            The station NSL codes to process. If None, all available stations</span>
<span class="sd">            in the inventory are processed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            The matching NSLC codes of the MSS units relating their</span>
<span class="sd">            serial numbers to the actual station locations.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">recorder_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">station_nsl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">station_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">get_station</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">station_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cur_nsl</span> <span class="ow">in</span> <span class="n">station_nsl</span><span class="p">:</span>
                <span class="n">cur_station</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">get_station</span><span class="p">(</span><span class="n">network</span> <span class="o">=</span> <span class="n">cur_nsl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                         <span class="n">name</span> <span class="o">=</span> <span class="n">cur_nsl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                         <span class="n">location</span> <span class="o">=</span> <span class="n">cur_nsl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_station</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are more than one stations. This is not yet supported.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_station</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No station found for </span><span class="si">{0:s}</span><span class="s1">. Check the input file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur_nsl</span><span class="p">))</span>
                <span class="n">cur_station</span> <span class="o">=</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">station_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_station</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">station_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cur_channel</span> <span class="ow">in</span> <span class="n">station</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
                <span class="n">stream_tb</span> <span class="o">=</span> <span class="n">cur_channel</span><span class="o">.</span><span class="n">get_stream</span><span class="p">(</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">())</span>
                <span class="n">cur_loc</span> <span class="o">=</span> <span class="n">stream_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cur_chan</span> <span class="o">=</span> <span class="n">stream_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">cur_key</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;XX&#39;</span><span class="p">,</span>
                           <span class="n">stream_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">serial</span><span class="p">,</span>
                           <span class="n">cur_loc</span><span class="p">,</span>
                           <span class="n">cur_chan</span><span class="p">)</span>
                <span class="n">recorder_map</span><span class="p">[</span><span class="n">cur_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_channel</span><span class="o">.</span><span class="n">nslc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">recorder_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">recorder_map</span></div>

<div class="viewcode-block" id="MonitorClient.reconnect"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.reconnect.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.reconnect">[docs]</a>    <span class="k">def</span> <span class="nf">reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Reconnect to the server.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reconnecting to the server.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cur_station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_stream</span><span class="p">(</span><span class="n">cur_station</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="MonitorClient.on_data"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.on_data.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.on_data">[docs]</a>    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Override the on_data callback function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self.logger.debug(&#39;Received trace:&#39;)</span>
        <span class="c1">#self.logger.debug(str(trace))</span>
        <span class="c1">#self.logger.debug(&quot;on_data trace data: %s&quot;, trace.data)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">cur_nslc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorder_map</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))]</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">cur_nslc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">cur_nslc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">cur_nslc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cur_nslc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="c1">#self.monitor_stream.merge(method = 1, fill_value = &#39;interpolate&#39;)</span>
        <span class="c1">#self.logger.debug(self.monitor_stream)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>
        <span class="c1">#self.logger.debug(&#39;Leaving on_data.&#39;)</span>

<div class="viewcode-block" id="MonitorClient.run"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.run.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Start streaming data from the SeedLink server.</span>

<span class="sd">        Streams need to be selected using</span>
<span class="sd">        :meth:`~.EasySeedLinkClient.select_stream` before this is called.</span>

<span class="sd">        This method enters an infinite loop, calling the client&#39;s callbacks</span>
<span class="sd">        when events occur.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: This somewhat resembles the run() method in SLClient.</span>

        <span class="c1"># Check if any streams have been specified (otherwise this will result</span>
        <span class="c1"># in an infinite reconnect loop in the SeedLinkConnection)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">streams</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No streams specified. Use select_stream() to select &#39;</span> <span class="o">+</span> \
                  <span class="s1">&#39;a stream.&#39;</span>
            <span class="k">raise</span> <span class="n">EasySeedLinkClientException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__streaming_started</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Start the processing timer thread.</span>
        <span class="c1">#self.process_timer_thread = threading.Thread(name = &#39;process_timer&#39;,</span>
        <span class="c1">#                                             target = self.task_timer,</span>
        <span class="c1">#                                             args = (self.process_monitor_stream, ))</span>

        <span class="c1">#self.process_timer_thread.start()</span>


        <span class="c1"># Start the collection loop</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Waiting to collect data....&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;... received some data.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="n">SLPacket</span><span class="o">.</span><span class="n">SLTERMINATE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_terminate</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="n">SLPacket</span><span class="o">.</span><span class="n">SLERROR</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_seedlink_error</span><span class="p">()</span>
                <span class="k">continue</span>

            <span class="c1"># At this point the received data should be a SeedLink packet</span>
            <span class="c1"># XXX In SLClient there is a check for data == None, but I think</span>
            <span class="c1">#     there is no way that self.conn.collect() can ever return None</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SLPacket</span><span class="p">))</span>

            <span class="n">packet_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>

            <span class="c1"># Ignore in-stream INFO packets (not supported)</span>
            <span class="k">if</span> <span class="n">packet_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SLPacket</span><span class="o">.</span><span class="n">TYPE_SLINF</span><span class="p">,</span> <span class="n">SLPacket</span><span class="o">.</span><span class="n">TYPE_SLINFT</span><span class="p">):</span>
                <span class="c1"># The packet should be a data packet</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_trace</span><span class="p">()</span>
                <span class="c1"># Pass the trace to the on_data callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_data</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

            <span class="c1"># Start the data export thread if the write_interval has been</span>
            <span class="c1"># reached.</span>
            <span class="c1">#if end and (end - start) &gt; self.write_interval:</span>
                <span class="c1">#process_thread = threading.Thread(target = process_monitor_stream, args = (self.monitor_stream, self.stream_lock, self.data_dir))</span>
                <span class="c1">#logging.info(&#39;Starting the processing thread.&#39;)</span>
                <span class="c1">#process_thread.start()</span>
                <span class="c1">#start = end</span>
                <span class="c1">#end = None</span>

<div class="viewcode-block" id="MonitorClient.on_terminate"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.on_terminate.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.on_terminate">[docs]</a>    <span class="k">def</span> <span class="nf">on_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Handle termination of the client.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Terminating the client.&#39;</span><span class="p">)</span>
        <span class="c1"># Clean the state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># Reconnect to the server.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t reconnect to the seedlink server.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="c1"># Stop the asyncio loop.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Stopping the asyncio event loop because there where troubles reconnecting to the seedlink server.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asyncio_loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="MonitorClient.on_seedlink_error"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.on_seedlink_error.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.on_seedlink_error">[docs]</a>    <span class="k">def</span> <span class="nf">on_seedlink_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Handle client errors.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got a seedlink error.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MonitorClient.task_timer"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.task_timer.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.task_timer">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">task_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; A timer executing a task at regular intervals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        callback: function</span>
<span class="sd">            The function to be called after the given process_interval.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting the timer.&#39;</span><span class="p">)</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_interval</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="n">delay_to_next_interval</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">%</span> <span class="n">interval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sleeping for </span><span class="si">%f</span><span class="s1"> seconds.&#39;</span><span class="p">,</span> <span class="n">delay_to_next_interval</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay_to_next_interval</span><span class="p">)</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;task_timer: Executing callback.&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">callback</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
            <span class="n">delay_to_next_interval</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">%</span> <span class="n">interval</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;task_timer: Sleeping for </span><span class="si">%f</span><span class="s1"> seconds.&#39;</span><span class="p">,</span> <span class="n">delay_to_next_interval</span><span class="p">)</span>
            <span class="c1">#time.sleep(delay_to_next_interval)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay_to_next_interval</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Leaving the task_timer method.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MonitorClient.detect_event_warning"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.detect_event_warning.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.detect_event_warning">[docs]</a>    <span class="k">def</span> <span class="nf">detect_event_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Run the Voronoi detection with the most recent PGV data only.</span>
<span class="sd">        This is a first crude detection of an event and is used for a</span>
<span class="sd">        first warning notification of a possible event. The warning has</span>
<span class="sd">        has to be confirmed by a detected event.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running detect_event_warning.&quot;</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span><span class="p">:</span>
            <span class="n">working_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Get the max. PGV and the related stations.</span>
        <span class="n">max_pgv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cur_trace</span> <span class="ow">in</span> <span class="n">working_stream</span><span class="p">:</span>
            <span class="n">max_pgv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
            <span class="n">stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">get_station</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Compute the Delaunay triangles.</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_delaunay</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>

        <span class="c1"># Convert the lists to numpy arrays.</span>
        <span class="n">max_pgv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">max_pgv</span><span class="p">)</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>

        <span class="c1"># Compute the Delaunay trigger.</span>
        <span class="n">trigger_pgv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">simp_stations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tri</span><span class="p">:</span>
            <span class="n">edge_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_edge_length</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span>
                                                   <span class="n">stations</span><span class="p">)</span>
            <span class="n">valid_tri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">edge_length</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">edge_length</span> <span class="o">=</span> <span class="n">edge_length</span><span class="p">[</span><span class="n">valid_tri</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cur_simp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">[</span><span class="n">valid_tri</span><span class="p">]):</span>
                <span class="n">cur_tri_pgv</span> <span class="o">=</span> <span class="n">max_pgv</span><span class="p">[</span><span class="n">cur_simp</span><span class="p">]</span>
                <span class="n">simp_stations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">[</span><span class="n">cur_simp</span><span class="p">]])</span>
                <span class="n">trigger_pgv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">cur_tri_pgv</span><span class="p">))</span>

        <span class="n">trigger_pgv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trigger_pgv</span><span class="p">)</span>
        <span class="n">simp_stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simp_stations</span><span class="p">)</span>

        <span class="c1"># Detect the event warning.</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">trigger_pgv</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warn_thr</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">[</span><span class="s1">&#39;simp_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simp_stations</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">[</span><span class="s1">&#39;trigger_pgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trigger_pgv</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_warning_available</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Event warning issued.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Event warning data: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">[</span><span class="s1">&#39;simp_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">[</span><span class="s1">&#39;trigger_pgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_warning_available</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No event warning issued.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished the event warning computation.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MonitorClient.detect_event"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.detect_event.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.detect_event">[docs]</a>    <span class="k">def</span> <span class="nf">detect_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Run the Voronoi event detection.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running the event detection.&#39;</span><span class="p">)</span>
        <span class="c1">#detect_win_length = 10</span>
        <span class="c1">#safety_win = 10</span>
        <span class="c1">#trigger_thr = self.trigger_thr</span>
        <span class="c1">#min_trigger_window = 3</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
            <span class="n">working_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;event detection working_stream: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">working_stream</span><span class="p">)</span>

        <span class="c1"># Run the Delaunay detection.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">init_detection_run</span><span class="p">(</span><span class="n">stream</span> <span class="o">=</span> <span class="n">working_stream</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detection_run_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">compute_trigger_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">evaluate_event_trigger</span><span class="p">()</span>

            <span class="c1"># Evaluate the detection result.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">new_event_available</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">get_event</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">current_event_available</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">detection_state</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rejected</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">max_pgv</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_event_thr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_event_length</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">detections</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_event_detections</span><span class="p">):</span>
                            <span class="c1"># If only one detection triangle is available, all three stations</span>
                            <span class="c1"># have to be above the 0.1 mm/s threshold.</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">detections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">cur_pgv_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">get_max_pgv_per_station</span><span class="p">()</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cur_pgv_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">&gt;=</span> <span class="mf">0.1e-3</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PGV of single detection event too small: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur_pgv_dict</span><span class="p">)</span>
                                    <span class="n">rejected</span> <span class="o">=</span> <span class="kc">True</span>
                                   
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">rejected</span><span class="p">:</span>
                                <span class="c1"># Save the event and its metadata in a thread to</span>
                                <span class="c1"># prevent blocking the data acquisition.</span>
                                <span class="c1"># TODO: Copy the event before exporting it. Deepcopy</span>
                                <span class="c1"># throws an error &quot;TypeError: can&#39;t pickle</span>
                                <span class="c1"># _thread.RLock objects&quot;.</span>
                                <span class="n">export_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span>
                                <span class="n">export_event_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;export_event&#39;</span><span class="p">,</span>
                                                                       <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_event</span><span class="p">,</span>
                                                                       <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">export_event</span><span class="p">,</span> <span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting the export_event_thread.&quot;</span><span class="p">)</span>
                                <span class="n">export_event_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                                <span class="c1"># TODO: Add some kind of event signaling to track the</span>
                                <span class="c1"># execution of the export thread.</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">export_event_thread</span> <span class="o">=</span> <span class="n">export_event_thread</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Continue the program execution.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rejected</span> <span class="o">=</span> <span class="kc">True</span>
                           
                        <span class="k">if</span> <span class="n">rejected</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rejected the event because it didn&#39;t fit the required parameters.&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;start_time: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;end_time: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;length: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;max_pgv: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">max_pgv</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;n_detections: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">detections</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;valid_event_thr: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_event_thr</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;min_event_length: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_event_length</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;min_event_detections: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_event_detections</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="c1"># Clear the detector flag.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">new_event_available</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to initialize the detection run.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorClient.process_monitor_stream"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.process_monitor_stream.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.process_monitor_stream">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">process_monitor_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Process the data in the monitor stream.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing the monitor_stream.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# gc.get_objects: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">()))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span><span class="p">:</span>
            <span class="n">monitor_stream_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;monitor_stream before selecting process stream: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">extended</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>

        <span class="c1"># The minimum length of a trace to be added to the process stream [s].</span>
        <span class="n">process_min_length</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="n">monitor_stream_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#now = obspy.UTCDateTime()</span>
            <span class="c1">#process_end_time = now - now.timestamp % self.process_interval</span>
            <span class="c1">#logger.debug(&#39;Trimming to end time: %s.&#39;, process_end_time)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cur_trace</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span><span class="p">:</span>
                    <span class="n">sec_remain</span> <span class="o">=</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_interval</span>
                    <span class="n">cur_end_time</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">sec_remain</span><span class="p">))</span>
                    <span class="n">cur_end_time</span> <span class="o">=</span> <span class="n">cur_end_time</span> <span class="o">-</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computed end_time: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                                      <span class="n">cur_end_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
                    <span class="c1"># Check if the trace length is larger xx seconds.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cur_end_time</span> <span class="o">-</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">process_min_length</span> <span class="o">-</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The process trace of </span><span class="si">%s</span><span class="s2"> with length </span><span class="si">%f</span><span class="s2"> would be smaller than </span><span class="si">%f</span><span class="s2"> seconds.&quot;</span><span class="p">,</span>
                                          <span class="n">cur_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">cur_end_time</span> <span class="o">-</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span>
                                          <span class="n">process_min_length</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Extracting process trace for </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">cur_slice_trace</span> <span class="o">=</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">endtime</span> <span class="o">=</span> <span class="n">cur_end_time</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_slice_trace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_slice_trace</span><span class="p">)</span>
                        <span class="n">cur_trace</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">cur_end_time</span> <span class="o">+</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;process_stream: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">extended</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;monitor_stream: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_stream</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">extended</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>

            <span class="c1"># Get a stream containing only equal length traces per station.</span>
            <span class="n">el_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_equal_length_traces</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Got el_stream: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">el_stream</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">extended</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>

            <span class="c1"># TODO: Handle the data in the process stream that has not been</span>
            <span class="c1"># used to create the el_stream.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Data not used for el_stream: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">extended</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>

            <span class="c1"># Detrend to remove eventual offset.</span>
            <span class="n">el_stream</span> <span class="o">=</span> <span class="n">el_stream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">el_stream</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="n">el_stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>

            <span class="c1"># Convert the amplitudes from counts to m/s.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_physical_units</span><span class="p">(</span><span class="n">el_stream</span><span class="p">)</span>

            <span class="c1"># Add the velocity waveform data to an archive stream.</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_stream</span> <span class="o">+</span> <span class="n">el_stream</span>

            <span class="c1"># Compute the PGV values.</span>
            <span class="c1"># TODO: Computing the PGV is CPU intensive and could block the</span>
            <span class="c1"># websocket server. Try to find a solution to move the computation to a</span>
            <span class="c1"># separate process.</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_pgv</span><span class="p">(</span><span class="n">el_stream</span><span class="p">)</span>

            <span class="c1"># Trim the archive stream.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_archive</span><span class="p">()</span>

            <span class="c1"># Start the event alarm detection using the most recent pgv values.</span>
            <span class="c1">#try:</span>
            <span class="c1">#    self.detect_event_warning()</span>
            <span class="c1">#except Exception as e:</span>
            <span class="c1">#    self.logger.exception(&quot;Error computing the event warning.&quot;)</span>

            <span class="c1"># Signal available PGV data.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgv_data_available</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="c1"># Start the event detection.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># TODO. Detecting the event is CPU intensive. Try to find a way</span>
                <span class="c1"># to move the detection to another process.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">detect_event</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error computing the event detection.&quot;</span><span class="p">)</span>

            <span class="c1"># Set the flag to mark another SOH state available.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_keydata_available</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">return</span>


            <span class="c1"># TODO: Check if something could be interesting and remove the code</span>
            <span class="c1"># below.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">export_stream</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The length of the traces in the stream is not equal. No export.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Add the stream back to the monitor stream.&#39;</span><span class="p">)</span>
                <span class="n">stream_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="n">monitor_stream</span> <span class="o">+=</span> <span class="n">export_stream</span>
                <span class="n">monitor_stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">monitor_stream</span><span class="p">)</span>
                <span class="n">stream_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">export_stream</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exporting the stream.&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cur_trace</span> <span class="ow">in</span> <span class="n">export_stream</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
                        <span class="n">cur_filename</span> <span class="o">=</span> <span class="s1">&#39;syscom_</span><span class="si">{0:s}</span><span class="s1">_</span><span class="si">{1:s}</span><span class="s1">.msd&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>
                        <span class="n">cur_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">cur_filename</span><span class="p">)</span>
                        <span class="n">export_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cur_filename</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;MSEED&#39;</span><span class="p">,</span> <span class="n">reclen</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="mi">11</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No data in stream.&#39;</span><span class="p">)</span>

            <span class="c1"># Delete old files.</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cur_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">cur_file</span><span class="p">))</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="o">-</span> <span class="mi">60</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">cur_file</span><span class="p">))</span></div>

<div class="viewcode-block" id="MonitorClient.get_equal_length_traces"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_equal_length_traces.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_equal_length_traces">[docs]</a>    <span class="k">def</span> <span class="nf">get_equal_length_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get a stream containing traces with equal length per station.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Computing equal length traces.&#39;</span><span class="p">)</span>
        <span class="n">unique_stations</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="p">]</span>
        <span class="n">unique_stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_stations</span><span class="p">))</span>
        <span class="n">unique_stations</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_stations</span><span class="p">)</span>
        <span class="n">el_stream</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cur_station</span> <span class="ow">in</span> <span class="n">unique_stations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting stream for </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">cur_station</span><span class="p">)</span>
            <span class="c1"># Get all traces for the station.</span>
            <span class="n">cur_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">network</span> <span class="o">=</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">station</span> <span class="o">=</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">location</span> <span class="o">=</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Selected stream: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">cur_stream</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cur_trace</span> <span class="ow">in</span> <span class="n">cur_stream</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cur_trace</span><span class="p">)</span>
            <span class="n">cur_stream</span> <span class="o">=</span> <span class="n">cur_stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>

            <span class="c1"># Check if all required channels are present:</span>
            <span class="n">missing_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">required_nslc</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorder_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">available_nslc</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                               <span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                               <span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                               <span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur_stream</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;available_nslc: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">available_nslc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;required_nslc: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">required_nslc</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">cur_required_nslc</span> <span class="ow">in</span> <span class="n">required_nslc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cur_required_nslc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_nslc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Data for channel </span><span class="si">%s</span><span class="s1"> is missing.&#39;</span><span class="p">,</span>
                                      <span class="n">cur_required_nslc</span><span class="p">)</span>
                    <span class="n">missing_data</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">missing_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipping station because of missing channel data. Re-inserting the data into the process stream.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cur_stream</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Select a timespan with equal end time. Re-insert the remaining</span>
            <span class="c1"># stream into the process_stream.</span>
            <span class="n">min_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur_stream</span><span class="p">])</span>
            <span class="n">cur_el_stream</span> <span class="o">=</span> <span class="n">cur_stream</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">endtime</span> <span class="o">=</span> <span class="n">min_end</span><span class="p">)</span>
            <span class="n">cur_rem_stream</span> <span class="o">=</span> <span class="n">cur_stream</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">min_end</span> <span class="o">+</span> <span class="n">cur_el_stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_stream</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cur_rem_stream</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Remaining stream added back to the process stream: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cur_rem_stream</span><span class="p">)</span>

            <span class="c1"># In case of non-equal start times, drop the data before the common</span>
            <span class="c1"># start time.</span>
            <span class="n">max_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur_el_stream</span><span class="p">])</span>
            <span class="n">cur_rem_stream</span> <span class="o">=</span> <span class="n">cur_el_stream</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">endtime</span> <span class="o">=</span> <span class="n">max_start</span> <span class="o">-</span> <span class="n">cur_el_stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
            <span class="n">cur_el_stream</span> <span class="o">=</span> <span class="n">cur_el_stream</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">max_start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stream dropped because the start time was not equal: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cur_rem_stream</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;el_stream: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cur_el_stream</span><span class="p">)</span>
            <span class="n">el_stream</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cur_el_stream</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">el_stream</span></div>

<div class="viewcode-block" id="MonitorClient.compute_pgv"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.compute_pgv.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.compute_pgv">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">compute_pgv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Compute the PGV values of the stream.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stream: :class:`obspy.Stream`</span>
<span class="sd">            The stream used to compute the PGV data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing the PGV.&#39;</span><span class="p">)</span>
        <span class="n">unique_stations</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">]</span>
        <span class="n">unique_stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_stations</span><span class="p">))</span>
        <span class="n">samp_interval</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_sps</span>

        <span class="c1"># Clear the PGV stream in case, it has not been served by the</span>
        <span class="c1"># websocket server.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cur_station</span> <span class="ow">in</span> <span class="n">unique_stations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting stream for </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">cur_station</span><span class="p">)</span>
            <span class="c1"># Get all traces for the station.</span>
            <span class="n">cur_stream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">network</span> <span class="o">=</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">station</span> <span class="o">=</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">location</span> <span class="o">=</span> <span class="n">cur_station</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Selected stream: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">cur_stream</span><span class="p">)</span>

            <span class="n">min_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur_stream</span><span class="p">])</span>
            <span class="n">sec_remain</span> <span class="o">=</span> <span class="n">min_start</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">%</span> <span class="n">samp_interval</span>
            <span class="n">cur_offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">sec_remain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;offset: </span><span class="si">%f</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">cur_offset</span><span class="p">)</span>
            <span class="n">cur_delta</span> <span class="o">=</span> <span class="n">cur_stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>

            <span class="n">cur_pgv</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">win_st</span> <span class="ow">in</span> <span class="n">cur_stream</span><span class="o">.</span><span class="n">slide</span><span class="p">(</span><span class="n">window_length</span> <span class="o">=</span> <span class="n">samp_interval</span> <span class="o">-</span> <span class="n">cur_delta</span><span class="p">,</span>
                                           <span class="n">step</span> <span class="o">=</span> <span class="n">samp_interval</span><span class="p">,</span>
                                           <span class="n">offset</span> <span class="o">=</span> <span class="n">cur_offset</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Processing stream slice: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">win_st</span><span class="p">)</span>
                <span class="n">x_st</span> <span class="o">=</span> <span class="n">win_st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;Hparallel&#39;</span><span class="p">)</span>
                <span class="n">y_st</span> <span class="o">=</span> <span class="n">win_st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;Hnormal&#39;</span><span class="p">)</span>

                <span class="c1"># TODO: It is assumed, that there are no gaps in the data.</span>
                <span class="c1"># Handle this problem.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_st</span><span class="o">.</span><span class="n">traces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Too many traces in the stream slice.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cur_x_trace</span><span class="p">,</span> <span class="n">cur_y_trace</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_st</span><span class="o">.</span><span class="n">traces</span><span class="p">,</span> <span class="n">y_st</span><span class="o">.</span><span class="n">traces</span><span class="p">):</span>
                    <span class="n">cur_x</span> <span class="o">=</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">data</span>
                    <span class="n">cur_y</span> <span class="o">=</span> <span class="n">cur_y_trace</span><span class="o">.</span><span class="n">data</span>

                    <span class="c1"># Handle masked arrays.</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
                        <span class="n">cur_x</span> <span class="o">=</span> <span class="n">cur_x</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
                        <span class="n">cur_y</span> <span class="o">=</span> <span class="n">cur_y</span><span class="o">.</span><span class="n">data</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_y</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The x and y data lenght dont&#39;t match. Can&#39;t compute the res. PGV for station </span><span class="si">%s</span><span class="s2"> and windowed stream: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">cur_station</span><span class="p">,</span> <span class="n">win_st</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Check for nan values.</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cur_x</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cur_y</span><span class="p">)):</span>
                        <span class="n">nan_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cur_x</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cur_y</span><span class="p">)</span>
                        <span class="n">cur_x</span> <span class="o">=</span> <span class="n">cur_x</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">]</span>
                        <span class="n">cur_y</span> <span class="o">=</span> <span class="n">cur_y</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">]</span>

                    <span class="c1"># Check if there are enough data values available.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_x_trace</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There are not enough non-nan data values available. Skipping this window. win_st: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">win_st</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">cur_sec_remain</span> <span class="o">=</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">%</span> <span class="n">samp_interval</span>
                    <span class="n">cur_win_start</span> <span class="o">=</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="n">cur_sec_remain</span>
                    <span class="n">cur_pgv_time</span> <span class="o">=</span> <span class="n">cur_win_start</span> <span class="o">+</span> <span class="n">samp_interval</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">cur_pgv_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cur_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cur_y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">cur_pgv</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cur_pgv_time</span><span class="p">,</span> <span class="n">cur_pgv_value</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">cur_pgv</span><span class="p">:</span>
                <span class="n">cur_pgv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cur_pgv</span><span class="p">)</span>
                <span class="c1">#self.logger.debug(&#39;cur_x: %s&#39;, cur_x)</span>
                <span class="c1">#self.logger.debug(&#39;cur_y: %s&#39;, cur_y)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cur_pgv: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cur_pgv</span><span class="p">)</span>
                <span class="n">cur_stats</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                             <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                             <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                             <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="s1">&#39;pgv&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;sampling_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_sps</span><span class="p">,</span>
                             <span class="s1">&#39;starttime&#39;</span><span class="p">:</span> <span class="n">cur_pgv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;data type: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">cur_pgv</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">cur_pgv_trace</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">cur_pgv</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                                 <span class="n">header</span> <span class="o">=</span> <span class="n">cur_stats</span><span class="p">)</span>
                <span class="c1"># Write the data to the current pgv stream.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_pgv_trace</span><span class="p">)</span>

        <span class="c1"># Merge the current pgv stream.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;pgv_stream: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">extended</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span>

        <span class="c1"># Merge the archive stream.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;pgv_archive_stream: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">extended</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished compute_pgv.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorClient.convert_to_physical_units"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.convert_to_physical_units.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.convert_to_physical_units">[docs]</a>    <span class="k">def</span> <span class="nf">convert_to_physical_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Convert the counts to physical units.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stream: :class:`obspy.Stream`</span>
<span class="sd">            The stream to convert.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">traces</span><span class="p">:</span>
            <span class="n">station</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">get_station</span><span class="p">(</span><span class="n">network</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                                                 <span class="n">name</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                                                 <span class="n">location</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">station</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are more than one stations. This is not yet supported.&#39;</span><span class="p">)</span>
            <span class="n">station</span> <span class="o">=</span> <span class="n">station</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">channel</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are more than one channels. This is not yet supported.&#39;</span><span class="p">)</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">stream_tb</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_stream</span><span class="p">(</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span>
                                           <span class="n">end_time</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_tb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are more than one recorder streams. This is not yet supported.&#39;</span><span class="p">)</span>
            <span class="n">rec_stream</span> <span class="o">=</span> <span class="n">stream_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span>

            <span class="n">rec_stream_param</span> <span class="o">=</span> <span class="n">rec_stream</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span>
                                                        <span class="n">end_time</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rec_stream_param</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are more than one recorder stream parameters. This is not yet supported.&#39;</span><span class="p">)</span>
            <span class="n">rec_stream_param</span> <span class="o">=</span> <span class="n">rec_stream_param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


            <span class="n">components_tb</span> <span class="o">=</span> <span class="n">rec_stream</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span>
                                                     <span class="n">end_time</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components_tb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are more than one components. This is not yet supported.&#39;</span><span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">components_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span>
            <span class="n">comp_param</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span>
                                                 <span class="n">end_time</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_param</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are more than one parameters for this component. This is not yet supported.&#39;</span><span class="p">)</span>

            <span class="n">comp_param</span> <span class="o">=</span> <span class="n">comp_param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;bitweight: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rec_stream_param</span><span class="o">.</span><span class="n">bitweight</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;gain: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rec_stream_param</span><span class="o">.</span><span class="n">gain</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;sensitivity: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">comp_param</span><span class="o">.</span><span class="n">sensitivity</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">rec_stream_param</span><span class="o">.</span><span class="n">bitweight</span> <span class="o">/</span> <span class="p">(</span><span class="n">rec_stream_param</span><span class="o">.</span><span class="n">gain</span> <span class="o">*</span> <span class="n">comp_param</span><span class="o">.</span><span class="n">sensitivity</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">output_unit</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>

<div class="viewcode-block" id="MonitorClient.compute_pgv_res"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.compute_pgv_res.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.compute_pgv_res">[docs]</a>    <span class="k">def</span> <span class="nf">compute_pgv_res</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Compute the resultant of the peak-ground-velocity.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">x_st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;Hparallel&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="n">y_st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;Hnormal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>

        <span class="n">res_st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cur_x_trace</span><span class="p">,</span> <span class="n">cur_y_trace</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_st</span><span class="o">.</span><span class="n">traces</span><span class="p">,</span> <span class="n">y_st</span><span class="o">.</span><span class="n">traces</span><span class="p">):</span>
            <span class="n">cur_x</span> <span class="o">=</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">data</span>
            <span class="n">cur_y</span> <span class="o">=</span> <span class="n">cur_y_trace</span><span class="o">.</span><span class="n">data</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_y</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The x and y data lenght dont&#39;t match. Can&#39;t compute the res. PGV for this trace.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;x: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur_x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;y: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur_y</span><span class="p">)</span>

            <span class="n">cur_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cur_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cur_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">cur_stats</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="s1">&#39;res&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;sampling_rate&#39;</span><span class="p">:</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;starttime&#39;</span><span class="p">:</span> <span class="n">cur_x_trace</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]}</span>
            <span class="n">res_trace</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">cur_res</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">cur_stats</span><span class="p">)</span>
            <span class="n">res_st</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_trace</span><span class="p">)</span>

        <span class="n">res_st</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">res_st</span></div>

<div class="viewcode-block" id="MonitorClient.get_triggered_stations"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_triggered_stations.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_triggered_stations">[docs]</a>    <span class="k">def</span> <span class="nf">get_triggered_stations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get the stations which have a PGV exceeding the threshold value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="n">window</span> <span class="o">=</span> <span class="mi">120</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
            <span class="n">working_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">working_stream</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">window</span><span class="p">)</span>
        <span class="n">all_stations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">triggered_stations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cur_trace</span> <span class="ow">in</span> <span class="n">working_stream</span><span class="p">:</span>
            <span class="n">cur_max_pgv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cur_max_pgv</span><span class="p">):</span>
                <span class="n">all_stations</span><span class="p">[</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_stations</span><span class="p">[</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_max_pgv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur_max_pgv</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">felt_thr</span><span class="p">:</span>
                <span class="n">triggered_stations</span><span class="p">[</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_max_pgv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;triggered_stations: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">triggered_stations</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">all_stations</span><span class="p">,</span> <span class="n">triggered_stations</span><span class="p">)</span></div>

<div class="viewcode-block" id="MonitorClient.get_triggered_event_stations"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_triggered_event_stations.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_triggered_event_stations">[docs]</a>    <span class="k">def</span> <span class="nf">get_triggered_event_stations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get the stations which have triggered during the last event.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="n">window</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="n">triggered_stations</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">window</span><span class="p">):</span>
            <span class="n">triggered_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">get_max_pgv_per_station</span><span class="p">()</span>
        <span class="c1">#elif self.event_archive and self.event_archive[&#39;start_time&#39;] &gt;= (now - window):</span>
        <span class="k">return</span> <span class="n">triggered_stations</span></div>

<div class="viewcode-block" id="MonitorClient.trim_archive"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.trim_archive.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.trim_archive">[docs]</a>    <span class="k">def</span> <span class="nf">trim_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Crop the archive to a specified length.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_end_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span> <span class="k">if</span> <span class="n">x</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;max_end_time: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">max_end_time</span><span class="p">)</span>
                <span class="n">crop_start_time</span> <span class="o">=</span> <span class="n">max_end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">crop_start_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trimmed the pgv archive stream start time to </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                                  <span class="n">crop_start_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;pgv_archive_stream: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_stream</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_end_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_stream</span> <span class="k">if</span> <span class="n">x</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;max_end_time: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">max_end_time</span><span class="p">)</span>
                <span class="n">crop_start_time</span> <span class="o">=</span> <span class="n">max_end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_stream</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">crop_start_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trimmed the velocity archive stream start time to </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                                  <span class="n">crop_start_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;vel_archive_stream: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_stream</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorClient.export_event"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.export_event.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.export_event">[docs]</a>    <span class="k">def</span> <span class="nf">export_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save the event.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        export_event: :class:`mss_dataserver.event.core.Event`</span>
<span class="sd">            The event to export.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Get or create the event catalog and add the event to it.</span>
        <span class="n">cat_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:04d}</span><span class="s2">-</span><span class="si">{1:02d}</span><span class="s2">-</span><span class="si">{2:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">export_event</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                                    <span class="n">export_event</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                    <span class="n">export_event</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lock</span><span class="p">:</span>
            <span class="n">config_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;config_filepath&#39;</span><span class="p">]</span>
            <span class="n">cur_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">get_event_catalog</span><span class="p">(</span><span class="n">cat_name</span><span class="p">)</span>
            <span class="n">cur_cat</span><span class="o">.</span><span class="n">add_events</span><span class="p">([</span><span class="n">export_event</span><span class="p">,</span> <span class="p">])</span>

            <span class="c1"># Get or create the detection catalog and add the event</span>
            <span class="c1"># detections to it.</span>
            <span class="n">det_catalogs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">get_detection_catalog_names</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cat_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">det_catalogs</span><span class="p">:</span>
                <span class="n">cur_det_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">create_detection_catalog</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">cat_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cur_det_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">load_detection_catalog</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">cat_name</span><span class="p">)</span>
            <span class="n">cur_det_cat</span><span class="o">.</span><span class="n">add_detections</span><span class="p">(</span><span class="n">export_event</span><span class="o">.</span><span class="n">detections</span><span class="p">)</span>

            <span class="c1"># Write the detections to the database. This has to be done</span>
            <span class="c1"># separately. Adding the detection to the event and then</span>
            <span class="c1"># writing the event to the database doesn&#39;t write the</span>
            <span class="c1"># detections to the database.</span>
            <span class="c1"># TODO: An error occured, because the detection already had</span>
            <span class="c1"># a database id assigned, and the write_to_database method</span>
            <span class="c1"># tried to update the existing detection. This part of the</span>
            <span class="c1"># method is not yet working, thus an error was thrown. This</span>
            <span class="c1"># should not happen, because only fresh detections with no</span>
            <span class="c1"># database id should be available at this point!!!!!</span>
            <span class="k">for</span> <span class="n">cur_detection</span> <span class="ow">in</span> <span class="n">export_event</span><span class="o">.</span><span class="n">detections</span><span class="p">:</span>
                <span class="n">cur_detection</span><span class="o">.</span><span class="n">write_to_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>

            <span class="c1"># Write the event to the database.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing the event to the database.&quot;</span><span class="p">)</span>
            <span class="n">export_event</span><span class="o">.</span><span class="n">write_to_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>

        <span class="c1"># Export the event data to disk files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exporting the event data.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_event_supplement</span><span class="p">(</span><span class="n">export_event</span><span class="p">)</span>

        <span class="c1"># Set the event to notify that the archive has changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_archive_changed</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="c1"># Compute the geojson supplement data.</span>
        <span class="n">proc_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;mssds_postprocess&#39;</span><span class="p">,</span>
                                      <span class="n">config_filepath</span><span class="p">,</span>
                                      <span class="s1">&#39;process-event&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;--public-id&#39;</span><span class="p">,</span>
                                      <span class="n">export_event</span><span class="o">.</span><span class="n">public_id</span><span class="p">,</span>
                                      <span class="s1">&#39;--no-pgv-contour-sequence&#39;</span><span class="p">])</span>

        <span class="c1"># Trim the event catalogs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trim_archive_catalogs</span><span class="p">(</span><span class="n">hours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_archive_timespan</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorClient.get_event_supplement_dir"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_event_supplement_dir.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_event_supplement_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_supplement_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">public_id</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get the supplement directory of an event.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        public_id: str </span>
<span class="sd">            The public ID of the event.</span>

<span class="sd">        category: str </span>
<span class="sd">            The supplement data category.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str </span>
<span class="sd">            The path to the event supplement data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">event_dir</span> <span class="o">=</span> <span class="n">pp_util</span><span class="o">.</span><span class="n">event_dir_from_publicid</span><span class="p">(</span><span class="n">public_id</span><span class="p">)</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supplement_dir</span><span class="p">,</span>
                                  <span class="n">event_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sup_map</span> <span class="o">=</span> <span class="n">pp_util</span><span class="o">.</span><span class="n">get_supplement_map</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">sup_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span>
                                          <span class="n">category</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;The category </span><span class="si">%s</span><span class="s1"> was not found in the available supllement data categories.&#39;</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output_dir</span></div>


<div class="viewcode-block" id="MonitorClient.save_event_supplement"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.save_event_supplement.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.save_event_supplement">[docs]</a>    <span class="k">def</span> <span class="nf">save_event_supplement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save the supplement data of the event.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        export_event: :class:`mss_dataserver.event.core.Event`</span>
<span class="sd">            The event for which to export the supplement data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Build the output directory.</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_supplement_dir</span><span class="p">(</span><span class="n">public_id</span> <span class="o">=</span> <span class="n">export_event</span><span class="o">.</span><span class="n">public_id</span><span class="p">,</span>
                                                   <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;detectiondata&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exporting the event data to folder </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="c1"># The timespan to add in front or at the back of the event limits</span>
        <span class="c1"># when exporting waveform data.</span>
        <span class="n">pre_win</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">post_win</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="n">pgv_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_supplement_pgv</span><span class="p">(</span><span class="n">event</span> <span class="o">=</span> <span class="n">export_event</span><span class="p">,</span>
                                              <span class="n">pre_win</span> <span class="o">=</span> <span class="n">pre_win</span><span class="p">,</span>
                                              <span class="n">post_win</span> <span class="o">=</span> <span class="n">post_win</span><span class="p">,</span>
                                              <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_supplement_vel</span><span class="p">(</span><span class="n">event</span> <span class="o">=</span> <span class="n">export_event</span><span class="p">,</span>
                                 <span class="n">pre_win</span> <span class="o">=</span> <span class="n">pre_win</span><span class="p">,</span>
                                 <span class="n">post_win</span> <span class="o">=</span> <span class="n">post_win</span><span class="p">,</span>
                                 <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_supplement_inventory</span><span class="p">(</span><span class="n">event</span> <span class="o">=</span> <span class="n">export_event</span><span class="p">,</span>
                                       <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_supplement_metadata</span><span class="p">(</span><span class="n">event</span> <span class="o">=</span> <span class="n">export_event</span><span class="p">,</span>
                                      <span class="n">pgv_stream</span> <span class="o">=</span> <span class="n">pgv_stream</span><span class="p">,</span>
                                      <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_supplement_detection_data</span><span class="p">(</span><span class="n">event</span> <span class="o">=</span> <span class="n">export_event</span><span class="p">,</span>
                                            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorClient.save_supplement_pgv"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_pgv.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_pgv">[docs]</a>    <span class="k">def</span> <span class="nf">save_supplement_pgv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">pre_win</span><span class="p">,</span> <span class="n">post_win</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save the PGV data supplement.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event: :class:`mss_dataserver.event.core.Event`</span>
<span class="sd">            The event for which to export the PGV data.</span>

<span class="sd">        pre_win: float</span>
<span class="sd">            The window to add before the start time of the event [s].</span>

<span class="sd">        post_win: float</span>
<span class="sd">            The window to add after the end time of the event [s].</span>

<span class="sd">        output_dir: str </span>
<span class="sd">            The path where to save the data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`obspy.Stream`</span>
<span class="sd">            The exported PGV data stream.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">start_time</span> <span class="o">-</span> <span class="n">pre_win</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">end_time</span> <span class="o">+</span> <span class="n">post_win</span>
        <span class="c1"># Get the PGV data from the archive stream.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
            <span class="n">pgv_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">start_time</span><span class="p">,</span>
                                                       <span class="n">endtime</span> <span class="o">=</span> <span class="n">end_time</span><span class="p">)</span>

        <span class="c1"># Split the pgv stream to ensure a propper export to miniseed file.</span>
        <span class="n">split_pgv_stream</span> <span class="o">=</span> <span class="n">pgv_stream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="n">supplement_name</span> <span class="o">=</span> <span class="s1">&#39;pgv&#39;</span>
        <span class="n">supplement_category</span> <span class="o">=</span> <span class="s1">&#39;detectiondata&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{public_id}</span><span class="s2">_</span><span class="si">{category}</span><span class="s2">_</span><span class="si">{name}</span><span class="s2">.msd&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">public_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">public_id</span><span class="p">,</span>
                                                              <span class="n">category</span> <span class="o">=</span> <span class="n">supplement_category</span><span class="p">,</span>
                                                              <span class="n">name</span> <span class="o">=</span> <span class="n">supplement_name</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing the PGV data to file </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="n">split_pgv_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span>
                               <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;MSEED&#39;</span><span class="p">,</span>
                               <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">)</span>

        <span class="c1"># The miniseed file is not compressed, because it is using float</span>
        <span class="c1"># values. Compress it using gzip.</span>
        <span class="n">zip_filepath</span> <span class="o">=</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zip_filepath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>

        <span class="c1"># Remove the uncompressed file.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pgv_stream</span></div>


<div class="viewcode-block" id="MonitorClient.save_supplement_vel"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_vel.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_vel">[docs]</a>    <span class="k">def</span> <span class="nf">save_supplement_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">pre_win</span><span class="p">,</span> <span class="n">post_win</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save the velocity data supplement.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event: :class:`mss_dataserver.event.core.Event`</span>
<span class="sd">            The event for which to export the velocity data.</span>

<span class="sd">        pre_win: float</span>
<span class="sd">            The window to add before the start time of the event [s].</span>

<span class="sd">        post_win: float</span>
<span class="sd">            The window to add after the end time of the event [s].</span>

<span class="sd">        output_dir: str </span>
<span class="sd">            The path where to save the data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">start_time</span> <span class="o">-</span> <span class="n">pre_win</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">end_time</span> <span class="o">+</span> <span class="n">post_win</span>
        <span class="c1"># Get the velocity data from the archive.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
            <span class="n">vel_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_archive_stream</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">start_time</span><span class="p">,</span>
                                                       <span class="n">endtime</span> <span class="o">=</span> <span class="n">end_time</span><span class="p">)</span>
        <span class="n">vel_stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="n">vel_stream</span> <span class="o">=</span> <span class="n">vel_stream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;vel_stream: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vel_stream</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">extended</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">supplement_name</span> <span class="o">=</span> <span class="s1">&#39;velocity&#39;</span>
        <span class="n">supplement_category</span> <span class="o">=</span> <span class="s1">&#39;detectiondata&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{public_id}</span><span class="s2">_</span><span class="si">{category}</span><span class="s2">_</span><span class="si">{name}</span><span class="s2">.msd&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">public_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">public_id</span><span class="p">,</span>
                                                              <span class="n">category</span> <span class="o">=</span> <span class="n">supplement_category</span><span class="p">,</span>
                                                              <span class="n">name</span> <span class="o">=</span> <span class="n">supplement_name</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing the velocity data to file </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="n">vel_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span>
                         <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;MSEED&#39;</span><span class="p">,</span>
                         <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">)</span>
        <span class="c1"># The miniseed file is not compressed, because it is using float</span>
        <span class="c1"># values. Compress it using gzip.</span>
        <span class="n">zip_filepath</span> <span class="o">=</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zip_filepath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>

        <span class="c1"># Remove the uncompressed file.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>



<div class="viewcode-block" id="MonitorClient.save_supplement_inventory"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_inventory.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_inventory">[docs]</a>    <span class="k">def</span> <span class="nf">save_supplement_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save the supplement inventory data to a json file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event: :class:`mss_dataserver.event.core.Event`</span>
<span class="sd">            The event for which to export the velocity data.</span>

<span class="sd">        output_dir: str </span>
<span class="sd">            The path where to save the data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Write the inventory to a json file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">supplement_name</span> <span class="o">=</span> <span class="s1">&#39;geometryinventory&#39;</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;detectiondata&#39;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{public_id}</span><span class="s2">_</span><span class="si">{category}</span><span class="s2">_</span><span class="si">{name}</span><span class="s2">.json.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">public_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">public_id</span><span class="p">,</span>
                                                                      <span class="n">category</span> <span class="o">=</span> <span class="n">category</span><span class="p">,</span>
                                                                      <span class="n">name</span> <span class="o">=</span> <span class="n">supplement_name</span><span class="p">)</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing the geometry inventory data to file </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                             <span class="n">filepath</span><span class="p">)</span>

            <span class="c1"># Prepare the file container for exporting to json file.</span>
            <span class="n">container_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">container_data</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;db_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">db_id</span><span class="p">,</span>
                                          <span class="s1">&#39;public_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">public_id</span><span class="p">}</span>
            <span class="n">container_data</span><span class="p">[</span><span class="s1">&#39;inventory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="n">file_container</span> <span class="o">=</span> <span class="n">json_util</span><span class="o">.</span><span class="n">FileContainer</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_data</span><span class="p">,</span>
                                                     <span class="n">agency_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span><span class="p">,</span>
                                                     <span class="n">author_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">pref</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">file_container</span><span class="p">,</span>
                                 <span class="n">fp</span> <span class="o">=</span> <span class="n">json_file</span><span class="p">,</span>
                                 <span class="bp">cls</span> <span class="o">=</span> <span class="n">json_util</span><span class="o">.</span><span class="n">GeneralFileEncoder</span><span class="p">,</span>
                                 <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                 <span class="n">sort_keys</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error saving the geometry inventory data to json file.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorClient.save_supplement_metadata"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_metadata.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">save_supplement_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">pgv_stream</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save the supplement metadata to a json file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event: :class:`mss_dataserver.event.core.Event`</span>
<span class="sd">            The event for which to export the velocity data.</span>

<span class="sd">        pgv_stream: :class:`obspy.Stream`</span>
<span class="sd">            The PGV data stream of the event.</span>

<span class="sd">        output_dir: str </span>
<span class="sd">            The path where to save the data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pgv_stream</span> <span class="o">=</span> <span class="n">pgv_stream</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
                                      <span class="n">endtime</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

        <span class="c1"># Compute the maximum PGV values of all stations in the network.</span>
        <span class="n">max_network_pgv</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cur_trace</span> <span class="ow">in</span> <span class="n">pgv_stream</span><span class="p">:</span>
            <span class="n">cur_nsl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:s}</span><span class="s1">:</span><span class="si">{1:s}</span><span class="s1">:</span><span class="si">{2:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                                                 <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                                                 <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

            <span class="c1"># Handle eventually masked trace data.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
                <span class="n">max_pgv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_pgv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

            <span class="n">max_network_pgv</span><span class="p">[</span><span class="n">cur_nsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_pgv</span>

        <span class="c1"># Compute the maximum PGV values which have been used as a detection.</span>
        <span class="n">max_event_pgv</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get_max_pgv_per_station</span><span class="p">()</span>

        <span class="c1"># Compute the detection limits per station.</span>
        <span class="n">detection_limits</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get_detection_limits_per_station</span><span class="p">()</span>

        <span class="n">event_meta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">event_meta</span><span class="p">[</span><span class="s1">&#39;db_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">db_id</span>
        <span class="n">event_meta</span><span class="p">[</span><span class="s1">&#39;public_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">public_id</span>
        <span class="n">event_meta</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">start_time</span>
        <span class="n">event_meta</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">end_time</span>
        <span class="n">event_meta</span><span class="p">[</span><span class="s1">&#39;max_network_pgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_network_pgv</span>
        <span class="n">event_meta</span><span class="p">[</span><span class="s1">&#39;max_event_pgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_event_pgv</span>
        <span class="n">event_meta</span><span class="p">[</span><span class="s1">&#39;detection_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detection_limits</span>

        <span class="c1"># Write the event metadata to a json file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">supplement_name</span> <span class="o">=</span> <span class="s1">&#39;metadata&#39;</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;detectiondata&#39;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{public_id}</span><span class="s2">_</span><span class="si">{category}</span><span class="s2">_</span><span class="si">{name}</span><span class="s2">.json.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">public_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">public_id</span><span class="p">,</span>
                                                                      <span class="n">category</span> <span class="o">=</span> <span class="n">category</span><span class="p">,</span>
                                                                      <span class="n">name</span> <span class="o">=</span> <span class="n">supplement_name</span><span class="p">)</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing the event metadata data to file </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                             <span class="n">filepath</span><span class="p">)</span>

            <span class="c1"># Prepare the file container for exporting to json file.</span>
            <span class="n">container_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">container_data</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_meta</span>
            <span class="n">file_container</span> <span class="o">=</span> <span class="n">json_util</span><span class="o">.</span><span class="n">FileContainer</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_data</span><span class="p">,</span>
                                                     <span class="n">agency_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span><span class="p">,</span>
                                                     <span class="n">author_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">pref</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">file_container</span><span class="p">,</span>
                                 <span class="n">fp</span> <span class="o">=</span> <span class="n">json_file</span><span class="p">,</span>
                                 <span class="bp">cls</span> <span class="o">=</span> <span class="n">json_util</span><span class="o">.</span><span class="n">GeneralFileEncoder</span><span class="p">,</span>
                                 <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                 <span class="n">sort_keys</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error saving the event metadata data to json file.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorClient.save_supplement_detection_data"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_detection_data.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.save_supplement_detection_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_supplement_detection_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save the detection data of the event.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event: :class:`mss_dataserver.event.core.Event`</span>
<span class="sd">            The event for which to export the velocity data.</span>

<span class="sd">        output_dir: str </span>
<span class="sd">            The path where to save the data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Convert the time array UTCDateTime instances to timestamps to reduce</span>
        <span class="c1"># the size of the json file.</span>
        <span class="k">for</span> <span class="n">cur_key</span><span class="p">,</span> <span class="n">cur_item</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">detection_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">cur_data</span> <span class="ow">in</span> <span class="n">cur_item</span><span class="p">[</span><span class="s1">&#39;trigger_data&#39;</span><span class="p">]:</span>
                <span class="n">cur_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>

        <span class="c1"># Write the event detection data to a json file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">supplement_name</span> <span class="o">=</span> <span class="s1">&#39;detectiondata&#39;</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;detectiondata&#39;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{public_id}</span><span class="s2">_</span><span class="si">{category}</span><span class="s2">_</span><span class="si">{name}</span><span class="s2">.json.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">public_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">public_id</span><span class="p">,</span>
                                                                      <span class="n">category</span> <span class="o">=</span> <span class="n">category</span><span class="p">,</span>
                                                                      <span class="n">name</span> <span class="o">=</span> <span class="n">supplement_name</span><span class="p">)</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing the detection data to file </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                             <span class="n">filepath</span><span class="p">)</span>

            <span class="c1"># Prepare the file container for exporting to json file.</span>
            <span class="n">container_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">container_data</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;db_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">db_id</span><span class="p">,</span>
                                          <span class="s1">&#39;public_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">public_id</span><span class="p">}</span>
            <span class="n">container_data</span><span class="p">[</span><span class="s1">&#39;detection_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">detection_data</span>
            <span class="n">file_container</span> <span class="o">=</span> <span class="n">json_util</span><span class="o">.</span><span class="n">FileContainer</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_data</span><span class="p">,</span>
                                                     <span class="n">agency_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agency_uri</span><span class="p">,</span>
                                                     <span class="n">author_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_uri</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">pref</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">file_container</span><span class="p">,</span>
                                 <span class="n">fp</span> <span class="o">=</span> <span class="n">json_file</span><span class="p">,</span>
                                 <span class="bp">cls</span> <span class="o">=</span> <span class="n">json_util</span><span class="o">.</span><span class="n">SupplementDetectionDataEncoder</span><span class="p">,</span>
                                 <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                 <span class="n">sort_keys</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error saving the detection data to json file.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorClient.get_current_pgv"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_current_pgv.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_current_pgv">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_pgv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get the current PGV data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            The PGV data as a dictionary.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pgv_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
            <span class="n">working_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># The time to use for the history pgv [s].</span>
        <span class="n">history_period</span> <span class="o">=</span> <span class="mi">60</span>

        <span class="c1"># Trim the stream to the selected timespan.</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="n">now</span><span class="o">.</span><span class="n">milliseconds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">now</span><span class="o">.</span><span class="n">second</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">history_period</span>
        <span class="n">working_stream</span> <span class="o">=</span> <span class="n">working_stream</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">start_time</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cur_trace</span> <span class="ow">in</span> <span class="n">working_stream</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
                    <span class="n">cur_data</span> <span class="o">=</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_data</span> <span class="o">=</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span>

                <span class="n">cur_time</span> <span class="o">=</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">times</span><span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;utcdatetime&#39;</span><span class="p">)</span>
                <span class="n">cur_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cur_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cur_mask</span><span class="p">):</span>
                    <span class="n">cur_hist_pgv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cur_data</span><span class="p">))</span>
                    <span class="n">cur_latest_pgv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_data</span><span class="p">[</span><span class="n">cur_mask</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">cur_latest_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_time</span><span class="p">[</span><span class="n">cur_mask</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_latest_pgv</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">cur_latest_time</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">cur_hist_pgv</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pgv_history&#39;</span><span class="p">:</span> <span class="n">cur_hist_pgv</span><span class="p">,</span>
                       <span class="s1">&#39;latest_pgv&#39;</span><span class="p">:</span> <span class="n">cur_latest_pgv</span><span class="p">,</span>
                       <span class="s1">&#39;latest_time&#39;</span><span class="p">:</span> <span class="n">cur_latest_time</span><span class="p">}</span>
                <span class="n">cur_nsl</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                                    <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                                    <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">])</span>
                <span class="n">pgv_data</span><span class="p">[</span><span class="n">cur_nsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error while preparing the pgv archive.&quot;</span><span class="p">)</span>

        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;history_period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history_period</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;computation_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;pgv_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgv_data</span>
        <span class="k">return</span> <span class="n">data_dict</span></div>


<div class="viewcode-block" id="MonitorClient.get_pgv_timeseries"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_pgv_timeseries.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_pgv_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">get_pgv_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get the latest PGV timeseries data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            The PGV timeseries as a dictonary.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pgv_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cur_trace</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span><span class="p">:</span>
            <span class="n">cur_start_time</span> <span class="o">=</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># There have been some NaN values in the data. I couldn&#39;t</span>
                <span class="c1"># figure out where they came from. Make sure to replace them</span>
                <span class="c1"># with the nodata value before creating the pgv data.</span>
                <span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_value</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">times</span><span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;utcdatetime&quot;</span><span class="p">),</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="k">if</span> <span class="n">y</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_value</span><span class="p">]</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_value</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error getting the PGV data.&quot;</span><span class="p">)</span>

            <span class="n">cur_nsl</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                                <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                                <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">])</span>
            <span class="n">pgv_data</span><span class="p">[</span><span class="n">cur_nsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

        <span class="c1"># Clear the pgv stream.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgv_stream</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pgv_data</span></div>

<div class="viewcode-block" id="MonitorClient.get_pgv_timeseries_archive"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_pgv_timeseries_archive.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_pgv_timeseries_archive">[docs]</a>    <span class="k">def</span> <span class="nf">get_pgv_timeseries_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsl_code</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get the archived PGV timeseries data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nsl_code: :obj:`list` of :obj:`str`</span>
<span class="sd">            A list of NSL codes to process.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            The PGV data as a dictionary.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pgv_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_lock</span><span class="p">:</span>
            <span class="n">working_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgv_archive_stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># If provided select the required stations.</span>
        <span class="k">if</span> <span class="n">nsl_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp_stream</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cur_nsl</span> <span class="ow">in</span> <span class="n">nsl_code</span><span class="p">:</span>
                <span class="n">cur_parts</span> <span class="o">=</span> <span class="n">cur_nsl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">tmp_stream</span> <span class="o">+=</span> <span class="n">working_stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">network</span> <span class="o">=</span> <span class="n">cur_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">station</span> <span class="o">=</span> <span class="n">cur_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">location</span> <span class="o">=</span> <span class="n">cur_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">working_stream</span> <span class="o">=</span> <span class="n">tmp_stream</span>

        <span class="c1"># The time in seconds to send to the server.</span>
        <span class="n">display_time</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="n">now</span><span class="o">.</span><span class="n">milliseconds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">now</span><span class="o">.</span><span class="n">second</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">display_time</span>
        <span class="n">working_stream</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">start_time</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cur_trace</span> <span class="ow">in</span> <span class="n">working_stream</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># There have been some NaN values in the data. I couldn&#39;t</span>
                <span class="c1"># figure out where they came from. Make sure to replace them</span>
                <span class="c1"># with the nodata value before creating the pgv data.</span>
                <span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_value</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">times</span><span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;utcdatetime&quot;</span><span class="p">),</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="k">if</span> <span class="n">y</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_value</span><span class="p">]</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur_trace</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_value</span><span class="p">]</span>
                <span class="n">cur_nsl</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                                    <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                                    <span class="n">cur_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">])</span>
                <span class="n">pgv_data</span><span class="p">[</span><span class="n">cur_nsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error while preparing the pgv archive.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pgv_data</span></div>

<div class="viewcode-block" id="MonitorClient.get_current_event"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_current_event.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_current_event">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the current event in serializable form.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            The current event as a dictionary.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cur_event</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="p">:</span>
            <span class="n">cur_event</span> <span class="o">=</span> <span class="n">validation</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">db_id</span><span class="p">,</span>
                                         <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">public_id</span><span class="p">,</span>
                                         <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                                         <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                                         <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
                                         <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                                         <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
                                         <span class="n">max_pgv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">max_pgv</span><span class="p">,</span>
                                         <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">detection_state</span><span class="p">,</span>
                                         <span class="n">num_detections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">detections</span><span class="p">),</span>
                                         <span class="n">triggered_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span><span class="o">.</span><span class="n">triggered_stations</span><span class="p">)</span>
            <span class="n">cur_event</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

            <span class="c1"># TODO: Serve the detailed event data only on request.</span>
            <span class="c1">#cur_event[&#39;trigger_data&#39;] = self.current_event[&#39;trigger_data&#39;]</span>
            <span class="c1">#cur_event[&#39;overall_trigger_data&#39;] = self.current_event[&#39;overall_trigger_data&#39;]</span>
            <span class="c1">#cur_archive_event[&#39;max_station_pgv&#39;] = cur_event[&#39;max_station_pgv&#39;]</span>

        <span class="k">return</span> <span class="n">cur_event</span></div>

<div class="viewcode-block" id="MonitorClient.get_event_warning"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_event_warning.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_event_warning">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the current event warning in serializable form.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            The current event warning as a dictionary.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cur_warning</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">:</span>
            <span class="n">cur_warning</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">cur_warning</span><span class="p">[</span><span class="s1">&#39;simp_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">[</span><span class="s1">&#39;simp_stations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">cur_warning</span><span class="p">[</span><span class="s1">&#39;trigger_pgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_warning</span><span class="p">[</span><span class="s1">&#39;trigger_pgv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cur_warning</span></div>

<div class="viewcode-block" id="MonitorClient.get_recent_events"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_recent_events.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_recent_events">[docs]</a>    <span class="k">def</span> <span class="nf">get_recent_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the recent events in serializable form.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            The recent events as a dictionary.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">recent_event_timespan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_archive_timespan</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">//</span> <span class="mi">86400</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">)</span>
        <span class="n">request_start</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">recent_event_timespan</span> <span class="o">*</span> <span class="mi">3600</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lock</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">request_start</span><span class="p">)</span>
        <span class="n">cur_archive</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cur_event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;public_id: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">public_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;triggered_stations: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">triggered_stations</span><span class="p">)</span>
                <span class="n">cur_archive_event</span> <span class="o">=</span> <span class="n">validation</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="n">db_id</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">db_id</span><span class="p">,</span>
                                                     <span class="n">public_id</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">public_id</span><span class="p">,</span>
                                                     <span class="n">start_time</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                                                     <span class="n">end_time</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                                                     <span class="n">length</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
                                                     <span class="n">description</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                                                     <span class="n">comment</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
                                                     <span class="n">max_pgv</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">max_pgv</span><span class="p">,</span>
                                                     <span class="n">state</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">detection_state</span><span class="p">,</span>
                                                     <span class="n">num_detections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_event</span><span class="o">.</span><span class="n">detections</span><span class="p">),</span>
                                                     <span class="n">triggered_stations</span> <span class="o">=</span> <span class="n">cur_event</span><span class="o">.</span><span class="n">triggered_stations</span><span class="p">)</span>

                <span class="n">cur_archive</span><span class="p">[</span><span class="n">cur_event</span><span class="o">.</span><span class="n">public_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_archive_event</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cur_archive</span></div>


<div class="viewcode-block" id="MonitorClient.get_event_by_id"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_event_by_id.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_event_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">public_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get an event by event id or public id.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ev_id: int </span>
<span class="sd">            The event database id.</span>

<span class="sd">        public_id: str </span>
<span class="sd">            The event public id.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`mss_dataserver.event.core.Event`</span>
<span class="sd">            The event matching the passed id.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ev_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">public_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Either the id or the public_id of the event have to be specified.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lock</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">load_event_by_id</span><span class="p">(</span><span class="n">ev_id</span> <span class="o">=</span> <span class="n">ev_id</span><span class="p">,</span>
                                                  <span class="n">public_id</span> <span class="o">=</span> <span class="n">public_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">event</span></div>


<div class="viewcode-block" id="MonitorClient.get_event_supplement"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_event_supplement.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_event_supplement">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_supplement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">public_id</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get the detailed data of an event.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        public_id: str </span>
<span class="sd">            The public id of the event.</span>

<span class="sd">        selection: :obj:`list` of :obj:`dict`</span>
<span class="sd">            The supplement data selection (keys: category, name).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            A dictionary containing the requested event supplement data.</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">event_supplement</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">event_supplement</span><span class="p">[</span><span class="s1">&#39;public_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">public_id</span>
        <span class="n">event_supplement</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#event = self.get_event_by_id(ev_id = ev_id,</span>
        <span class="c1">#                             public_id = public_id)</span>

        <span class="n">supp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_supplement_dir</span><span class="p">(</span><span class="n">public_id</span> <span class="o">=</span> <span class="n">public_id</span><span class="p">)</span>

        <span class="c1"># Check, if the supplement directory exists.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">supp_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The event supplement data directory </span><span class="si">% d</span><span class="s2">oesn&#39;t exist.&quot;</span><span class="p">,</span>
                              <span class="n">supp_dir</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">event_supplement</span>

        <span class="c1"># TODO: Check the available supplement data.</span>

        <span class="c1"># Load the supplement data.</span>
        <span class="k">for</span> <span class="n">cur_selection</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
            <span class="n">cur_category</span> <span class="o">=</span> <span class="n">cur_selection</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
            <span class="n">cur_name</span> <span class="o">=</span> <span class="n">cur_selection</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cur_data</span> <span class="o">=</span> <span class="n">pp_util</span><span class="o">.</span><span class="n">get_supplement_data</span><span class="p">(</span><span class="n">public_id</span> <span class="o">=</span> <span class="n">public_id</span><span class="p">,</span>
                                                       <span class="n">category</span> <span class="o">=</span> <span class="n">cur_category</span><span class="p">,</span>
                                                       <span class="n">name</span> <span class="o">=</span> <span class="n">cur_name</span><span class="p">,</span>
                                                       <span class="n">directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supplement_dir</span><span class="p">)</span>
                <span class="c1"># Convert the dataframe to json and revert it back to a dictionary to</span>
                <span class="c1"># ensure, that the data can be serialized when sendig it over the </span>
                <span class="c1"># websocket.</span>
                <span class="n">cur_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cur_data</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error getting the supplement data </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                                      <span class="n">cur_selection</span><span class="p">)</span>
                <span class="n">cur_data</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">cur_category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event_supplement</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">event_supplement</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">cur_category</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">event_supplement</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">cur_category</span><span class="p">][</span><span class="n">cur_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_data</span>

        <span class="k">return</span> <span class="n">event_supplement</span></div>


<div class="viewcode-block" id="MonitorClient.get_keydata"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_keydata.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_keydata">[docs]</a>    <span class="k">def</span> <span class="nf">get_keydata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the keydata.</span>

<span class="sd">        Used for the LWZ display.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            The keydata as a dictionary.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">all_stations</span><span class="p">,</span> <span class="n">triggered_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_triggered_stations</span><span class="p">()</span>
        <span class="n">keydata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">keydata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utcdatetime</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">keydata</span><span class="p">[</span><span class="s1">&#39;all_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_stations</span>
        <span class="n">keydata</span><span class="p">[</span><span class="s1">&#39;triggered_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">triggered_stations</span>
        <span class="n">keydata</span><span class="p">[</span><span class="s1">&#39;triggered_event_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_triggered_event_stations</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">keydata</span></div>


<div class="viewcode-block" id="MonitorClient.get_station_metadata"><a class="viewcode-back" href="../../../sourcedoc/autogen/mss_dataserver.monitorclient.monitorclient.MonitorClient.get_station_metadata.html#mss_dataserver.monitorclient.monitorclient.MonitorClient.get_station_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_station_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get the metadata of the available stations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`dict`</span>
<span class="sd">            The station metadata as a dictionary.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cur_station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">get_station</span><span class="p">():</span>
            <span class="n">active_streams</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cur_channel</span> <span class="ow">in</span> <span class="n">cur_station</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
                <span class="n">cur_streams</span> <span class="o">=</span> <span class="n">cur_channel</span><span class="o">.</span><span class="n">get_stream</span><span class="p">(</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">())</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cur_streams</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">active_streams</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">item</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur_streams</span><span class="p">])</span>

            <span class="n">unique_recorder_serials</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">serial</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">active_streams</span><span class="p">]))</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">cur_station</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                   <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">cur_station</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                   <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">cur_station</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                   <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">cur_station</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                   <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">cur_station</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                   <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">cur_station</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                   <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">cur_station</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                   <span class="s1">&#39;recorder_serials&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_recorder_serials</span><span class="p">)}</span>
            <span class="n">stations</span><span class="p">[</span><span class="n">cur_station</span><span class="o">.</span><span class="n">nsl_string</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

        <span class="k">return</span> <span class="n">stations</span></div></div>




</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Stefan Mertl.
      <span class="lastupdated">
        Last updated on 2021-06-01 20:17.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>